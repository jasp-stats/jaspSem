context("Structural Equation Modeling")

options <- jaspTools::analysisOptions("SEM")
options$models <- list(list(name = "Model1", syntax = list(model = "x1 ~ x2 + x3 + y1", columns = c("x1", "x2", "x3", "y1"))))
options$emulation         <- "lavaan"
options$estimator         <- "default"
options$group             <- ""
options$samplingWeights   <- ""
options$informationMatrix <- "expected"
options$naAction          <- "fiml"
options$modelTest         <- "standard"
results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)


test_that("Model fit table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]

  jaspTools::expect_equal_tables(table,
                                 list(48.156355426345, 59.7437959940266, 9.99200722162641e-14, "", "Model1",
                                      75, 0, 5, 5))
})

parcont <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]]
parcov  <- parcont[["modelContainer_params_cov"]][["data"]]
parreg  <- parcont[["modelContainer_params_reg"]][["data"]]
parvar  <- parcont[["modelContainer_params_var"]][["data"]]
partot  <- parcont[["modelContainer_params_toteff"]][["data"]]


test_that("Basic SEM covariance parameter table works", {
  expect_equal_tables(parcov, list(1.782009228184, 1.782009228184, 1.782009228184, "", "x2 - x3",
                                   "", 0, "", 1.2564136096, 1.2564136096, 1.2564136096, "", "x2 - y1",
                                   "", 0, "", 0.899301179999998, 0.899301179999998, 0.899301179999998,
                                   "", "x3 - y1", "", 0, ""),
                      "Covariance parameter table")
  expect_equal_tables(parreg, list(0.26348889641759, 0.446867412394827, 0.355178154406208, "x1",
                                   3.13082892944294e-14, "x2", 0.0467810932812294, 7.59234403247094,
                                   -0.018377879348242, 0.174214412813761, 0.0779182667327594, "x1",
                                   0.112759784761359, "x3", 0.0491315895805092, 1.58590974560428,
                                   0.00202079123204174, 0.0593563876703967, 0.0306885894512192,
                                   "x1", 0.0358943944804584, "y1", 0.014626696431825, 2.09812171834281),
                      "Regressions parameter table")
  expect_equal_tables(partot, list(0.26348889641759, 0.446867412394827, 0.355178154406208, "x2 <unicode> x1",
                                   3.13082892944294e-14, 0.0467810932812294, 7.59234403247094,
                                   -0.018377879348242, 0.174214412813761, 0.0779182667327594, "x3 <unicode> x1",
                                   0.112759784761359, 0.0491315895805092, 1.58590974560428, 0.00202079123204174,
                                   0.0593563876703967, 0.0306885894512192, "y1 <unicode> x1", 0.0358943944804584,
                                   0.014626696431825, 2.09812171834281),
                      "Total effects table")
  expect_equal_tables(parvar, list(0.0662130628477228, 0.128548647454031, "x1", 0.0973808551508767,
                                   "", "x1", 9.14129882900738e-10, 0.0159022270557018, 6.12372435695796,
                                   2.25167664969695, 2.25167664969695, "x2", 2.25167664969695,
                                   "", "x2", "", 0, "", 1.94967853807201, 1.94967853807201, "x3",
                                   1.94967853807201, "", "x3", "", 0, "", 6.78685155555555, 6.78685155555555,
                                   "y1", 6.78685155555555, "", "y1", "", 0, ""))
})


# Reliability, AVE, HTMT works
options <- jaspTools::analysisOptions("SEM")
options$models <- list(list(name = "Model1", syntax = list(model = "
# latent variable definitions
  ind60 =~ x1 + x2 + x3
  dem60 =~ y1 + y2 + y3 + y4
  dem65 =~ y5 + y6 + y7 + y8
# regressions
  dem60 ~ ind60
  dem65 ~ ind60 + dem60
# residual (co)variances
  y1 ~~ y5
  y2 ~~ y4 + y6
  y3 ~~ y7
  y4 ~~ y8
  y6 ~~ y8
", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))))
options$emulation         <- "lavaan"
options$estimator         <- "default"
options$group             <- ""
options$samplingWeights   <- ""
options$informationMatrix <- "expected"
options$naAction          <- "fiml"
options$modelTest         <- "standard"
options$reliability       <- TRUE
options$ave               <- TRUE
options$htmt              <- TRUE
results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)


container   <- results[["results"]][["modelContainer"]][["collection"]]
ave         <- container[["modelContainer_AVE"]][["data"]]
htmt        <- container[["modelContainer_htmt"]][["collection"]][["modelContainer_htmt_htmttab"]][["data"]]
reliability <- container[["modelContainer_reliability"]][["data"]]

test_that("reliability/ AVE/ htmt works", {
  expect_equal_tables(ave, list(0.8588015398276, "ind60", 0.597128239158634, "dem60", 0.640021072526866,
                                "dem65"))
  expect_equal_tables(htmt, list("", "", 1, 1, "", 0.420934414880351, 0.980709420149052, 1, 0.549916280338394
  ))
  expect_equal_tables(reliability, list("ind60", 0.902334680203148, 0.943690008441057, "dem60", 0.858794528217608,
                                        0.841179471771507, "dem65", 0.882739385479519, 0.857553923970666,
                                        "total", 0.91494164193877, 0.919205517992938))
})


# Multigroup, multimodel SEM works
options <- jaspTools::analysisOptions("SEM")
options$emulation                   = "lavaan"
options$estimator                   = "default"
options$group                       = "group"
options$informationMatrix           = "expected"
options$meanStructure               = TRUE
options$latentInterceptFixedToZero  = TRUE
options$modificationIndexLowHidden  = TRUE
options$naAction                    = "listwise"
options$impliedCovariance           = TRUE
options$mardiasCoefficient          = TRUE
options$modificationIndex           = TRUE
options$observedCovariance          = TRUE
options$pathPlot                    = TRUE
options$rSquared                    = TRUE
options$residualCovariance          = TRUE
options$standardizedResidual        = TRUE
options$pathPlotParameter           = TRUE
options$standardizedEstimate        = TRUE
options$modelTest                   = "satorraBentler"
options$samplingWeights             = ""

modelDefault <- list(model = "
# latent variable definitions
  ind60 =~ x1 + x2 + x3
  dem60 =~ y1 + y2 + y3 + y4
  dem65 =~ y5 + y6 + y7 + y8
# regressions
  dem60 ~ ind60
  dem65 ~ ind60 + dem60
# residual (co)variances
  y1 ~~ y5
  y2 ~~ y4 + y6
  y3 ~~ y7
  y4 ~~ y8
  y6 ~~ y8
", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))
modelConstrained <- list(model = "
# latent variable definitions
  ind60 =~ x1 + x2 + x3
  dem60 =~ c(a1,a2)*y1 + c(b1,b2)*y2 + c(c1,c2)*y3 + c(d1,d2)*y4
  dem65 =~ c(a1,a3)*y5 + c(b1,b3)*y6 + c(c1,c3)*y7 + c(d1,d3)*y8
# regressions
  dem60 ~ ind60
  dem65 ~ ind60 + dem60
# residual (co)variances
  y1 ~~ y5
  y2 ~~ y4 + y6
  y3 ~~ y7
  y4 ~~ y8
  y6 ~~ y8
", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))
modelMoreConstrained <- list(model = "
# latent variable definitions
  ind60 =~ x1 + x2 + x3
  dem60 =~ c(a1, a2)*y1 + c(b1, b2)*y2 + c(c1, c2)*y3 + c(d1, d2)*y4
  dem65 =~ c(a1, a2)*y5 + c(b1, b2)*y6 + c(c1, c2)*y7 + c(d1, d2)*y8
# regressions
  dem60 ~ ind60
  dem65 ~ ind60 + dem60
# residual (co)variances
  y1 ~~ y5
  y2 ~~ y4 + y6
  y3 ~~ y7
  y4 ~~ y8
  y6 ~~ y8
", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))

options$models = list(
  list(name = "default",          syntax = modelDefault),
  list(name = "constrained",      syntax = modelConstrained),
  list(name = "more constrained", syntax = modelMoreConstrained)
)

results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)


test_that("Model fit table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(3189.26691715402, 3383.93591869107, 85.6796813843016, 70, "default",
                                      75, 0.0980338951401504, "", "", "", "all", 84, 84, 3184.34803034567,
                                      3372.06456754211, 87.9549367720077, 73, "constrained", 75, 0.111927575441422,
                                      0.647754490400879, 1.65156784896072, 3, "all", 81, 84, 3181.07183366569,
                                      3361.83590652152, 92.7433708195404, 76, "more constrained",
                                      75, 0.0929761753673403, 0.110596895610441, 6.02091896551089,
                                      3, "all", 78, 84, 1638.81154499845, 1774.12864966057, 51.603527732831,
                                      70, "default", 37, 0.951434618744164, "", "", "", 1, 84, 84,
                                      1718.45537215556, 1856.01260957258, 34.0761536514706, 70, "default",
                                      38, 0.999909631385078, "", "", "", 2, 81, 84, 1639.89265814398,
                                      1775.2097628061, 53.4279668719256, 73, "constrained", 37, 0.958714294372556,
                                      0.609631201049421, 1.82443913909461, 3, 1, 78, 84, 1718.45537220169,
                                      1856.0126096187, 34.5269699000821, 73, "constrained", 38, 0.999963257835091,
                                      0.929556093266985, 0.450816248611517, 3, 2, 84, 84, 1639.89265813238,
                                      1775.20976279449, 54.5525537466108, 76, "more constrained",
                                      37, 0.970044580307764, 0.771142273547436, 1.12458687468522,
                                      3, 1, 81, 84, 1721.17917553332, 1858.73641295033, 38.1908170729296,
                                      76, "more constrained", 38, 0.999911473827655, 0.300125123328536,
                                      3.66384717284748, 3, 2, 78, 84))
})

test_that("R-Squared table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_rsquared"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(1, "x1", 0.883076871616544, 0.88344099961725, 0.883440941017384,
                                      1, "x2", 0.993698159869737, 0.993307380054294, 0.993308312239004,
                                      1, "x3", 0.734550879193546, 0.734754000085834, 0.734752992615783,
                                      1, "y1", 0.76374604003533, 0.78382522538215, 0.783824495338279,
                                      1, "y2", 0.52698823283752, 0.46980581123522, 0.469797871844076,
                                      1, "y3", 0.540743668690899, 0.602813004892641, 0.602813008521032,
                                      1, "y4", 0.758371834315632, 0.715732725592278, 0.715727580943501,
                                      1, "y5", 0.748735676904241, 0.760689523184986, 0.760685788176715,
                                      1, "y6", 0.626089440009365, 0.636528021958327, 0.63653017192483,
                                      1, "y7", 0.729758226751309, 0.710375682244039, 0.710376016894816,
                                      1, "y8", 0.574575906571732, 0.588831799668115, 0.588835817501575,
                                      1, "dem60", 0.275927380324135, 0.258157185403395, 0.258145005894785,
                                      1, "dem65", 0.941713333219214, 0.938883931908498, 0.938882940520488,
                                      2, "x1", 0.787475869571126, 0.78747617521673, 0.788439850883418,
                                      2, "x2", 0.90066092940223, 0.900660946749863, 0.900202685338523,
                                      2, "x3", 0.749867733548725, 0.749868295135394, 0.749372699570641,
                                      2, "y1", 0.73192194477315, 0.731929437708713, 0.683849857838006,
                                      2, "y2", 0.550065444500199, 0.550067399151619, 0.519184271086936,
                                      2, "y3", 0.465824888188388, 0.465819890503162, 0.543696244446078,
                                      2, "y4", 0.651968126202521, 0.651959003998254, 0.694898810552798,
                                      2, "y5", 0.536001769615457, 0.535995620432757, 0.598318029638634,
                                      2, "y6", 0.625808175301569, 0.625823134164411, 0.607599332020874,
                                      2, "y7", 0.658946836103404, 0.658945492261667, 0.618117097165968,
                                      2, "y8", 0.842442637402788, 0.842449295416932, 0.821972120799249,
                                      2, "dem60", 0.075359995596017, 0.0753581296999277, 0.0905522598183016,
                                      2, "dem65", 0.956917027167473, 0.956910675588687, 0.977886505597789
                                 ))
})

test_that("Mardia's coefficients table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_mardiasTable"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(330.897809673901, 26.471824773912, 286, "Skewness", 0.0347860345067629,
                                      "", "", 134.567190822067, "", "Kurtosis", 0.0308358026617142,
                                      -2.15918518879413))
})

# use more constrained model (model 3)
test_that("Residual covariances table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_cov"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(-0.69545315422001, 1.13004177555907, 0.21729431066953, 1, "",
                                      "y1 - y5", 0.640785259228911, 0.465696039360507, 0.122229400273519,
                                      0.21729431066953, 0.466601156771526, 0.433556460847522, 4.21291697813091,
                                      2.32323671948921, 1, "", "y2 - y4", 0.0159680098210635, 0.964140297243852,
                                      0.551561502186919, 2.32323671948921, 2.40964590540459, -0.453419237959931,
                                      2.50595123687697, 1.02626599945852, 1, "", "y2 - y6", 0.174028371605556,
                                      0.754955320143644, 0.193560311395833, 1.02626599945852, 1.35937316033915,
                                      -0.360831524130952, 2.44595509715677, 1.04256178651291, 1, "",
                                      "y3 - y7", 0.145384170744224, 0.716030152448538, 0.308401783417912,
                                      1.04256178651291, 1.45603056372383, -1.17525149467719, 0.804530353606657,
                                      -0.185360570535264, 1, "", "y4 - y8", 0.71361142744346, 0.50505567038479,
                                      -0.0554561326806879, -0.185360570535264, -0.367010176113937,
                                      -0.214945884705118, 3.12165697220312, 1.453355543749, 1, "",
                                      "y6 - y8", 0.0877403085918145, 0.851189839003914, 0.345429944586929,
                                      1.453355543749, 1.70743995892827, -0.11886742207512, 1.57858876509647,
                                      0.729860671510673, 2, "", "y1 - y5", 0.0918990888281619, 0.433032494617479,
                                      0.378922580175452, 0.729860671510673, 1.68546397922262, -0.465368071384424,
                                      3.32132373684632, 1.42797783273095, 2, "", "y2 - y4", 0.139348430266987,
                                      0.966010558892838, 0.272324473644519, 1.42797783273095, 1.47822176433307,
                                      0.0620106319572282, 4.11438168211907, 2.08819615703815, 2, "",
                                      "y2 - y6", 0.04338878872498, 1.03378712112223, 0.353104277180307,
                                      2.08819615703815, 2.01994793161217, -1.37202057656696, 2.36286703932462,
                                      0.495423231378828, 2, "", "y3 - y7", 0.603085629226233, 0.952794960864562,
                                      0.102496109909575, 0.495423231378828, 0.519968358070747, -0.467325344620023,
                                      1.95619519340853, 0.744434924394253, 2, "", "y4 - y8", 0.228555681754256,
                                      0.618256395817723, 0.289753166031713, 0.744434924394253, 1.20408770443797,
                                      -0.397060222177046, 2.20355649897204, 0.903248138397496, 2,
                                      "", "y6 - y8", 0.173364480031653, 0.663434823716767, 0.311727419658285,
                                      0.903248138397496, 1.3614723045999))
})

test_that("Factor Loadings table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_ind"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(1, 1, 1, 1, "a1", "dem60", "", "y1", 0, 0.88533863314456, 2.42166834174955,
                                      "", 0.760887096093589, 1.3313371657679, 1.04611213093074, 1,
                                      "b1", "dem60", 6.55031584528842e-13, "y2", 0.14552565102572,
                                      0.685418027078422, 2.53333662939515, 7.18850679283928, 0.783222538721797,
                                      1.29591955303164, 1.03957104587672, 1, "c1", "dem60", 1.99840144432528e-15,
                                      "y3", 0.130792458012987, 0.776410335145684, 2.51749629079912,
                                      7.9482491702503, 0.796321916480203, 1.254666698178, 1.0254943073291,
                                      1, "d1", "dem60", 0, "y4", 0.116926837766704, 0.846006844501568,
                                      2.48340709870327, 8.77039289624163, 1, 1, 1, 1, "a1", "dem65",
                                      "", "y5", 0, 0.872173026512925, 2.49219827699667, "", 0.76088709609359,
                                      1.3313371657679, 1.04611213093074, 1, "b1", "dem65", 6.55031584528842e-13,
                                      "y6", 0.14552565102572, 0.79782841007627, 2.60711885025092,
                                      7.18850679283928, 0.783222538721797, 1.29591955303164, 1.03957104587672,
                                      1, "c1", "dem65", 1.99840144432528e-15, "y7", 0.130792458012987,
                                      0.842838072760608, 2.59081716934959, 7.9482491702503, 0.796321916480202,
                                      1.254666698178, 1.0254943073291, 1, "d1", "dem65", 0, "y8",
                                      0.116926837766704, 0.767356382329342, 2.55573514579548, 8.77039289624164,
                                      1, 1, 1, 1, "", "ind60", "", "x1", 0, 0.939915390350315, 0.657997769223972,
                                      "", 1.94762156768505, 2.55197241207619, 2.24979698988062, 1,
                                      "", "ind60", 0, "x2", 0.15417396675607, 0.99664853997736, 1.48036140054826,
                                      14.5925867850322, 1.40827986384459, 2.2352973910192, 1.82178862743189,
                                      1, "", "ind60", 0, "x3", 0.210977735738517, 0.857177340237003,
                                      1.19873285284779, 8.63498046869645, 1, 1, 1, 2, "a2", "dem60",
                                      "", "y1", 0, 0.826952149666476, 1.88731847029564, "", 1.00619302224573,
                                      1.96819575821982, 1.48719439023278, 2, "b2", "dem60", 1.3615824023816e-09,
                                      "y2", 0.24541337074616, 0.720544426865503, 2.80680944160638,
                                      6.05995665888569, 0.971906075503644, 1.81486423470427, 1.39338515510396,
                                      2, "c2", "dem60", 9.20110654334394e-11, "y3", 0.215044298224298,
                                      0.737357609607495, 2.62976153946346, 6.47952615628345, 1.1349713565327,
                                      1.96970928417887, 1.55234032035579, 2, "d2", "dem60", 3.10418357685194e-13,
                                      "y4", 0.212947261845238, 0.833605908420039, 2.92976055879213,
                                      7.28978765401534, 1, 1, 1, 2, "a2", "dem65", "", "y5", 0, 0.773510200087002,
                                      1.83190459395512, "", 1.00619302224573, 1.96819575821982, 1.48719439023278,
                                      2, "b2", "dem65", 1.3615824023816e-09, "y6", 0.24541337074616,
                                      0.77948658232254, 2.7243982355717, 6.05995665888569, 0.971906075503644,
                                      1.81486423470427, 1.39338515510396, 2, "c2", "dem65", 9.20110654334394e-11,
                                      "y7", 0.215044298224298, 0.78620423374971, 2.55254866678381,
                                      6.47952615628345, 1.1349713565327, 1.96970928417887, 1.55234032035579,
                                      2, "d2", "dem65", 3.10418357685194e-13, "y8", 0.212947261845238,
                                      0.90662678142621, 2.84373936424153, 7.28978765401534, 1, 1,
                                      1, 2, "", "ind60", "", "x1", 0, 0.887941355542931, 0.569877660945581,
                                      "", 1.83150200846409, 2.8887820741669, 2.3601420413155, 2, "",
                                      "ind60", 0, "x2", 0.269719258629878, 0.94879011658982, 1.3449922260042,
                                      8.75036529947683, 1.44864109706261, 2.46588646575614, 1.95726378140937,
                                      2, "", "ind60", 4.61852778244065e-14, "x3", 0.25950613805086,
                                      0.865663155950766, 1.11540090560308, 7.54226391757168))
})

test_that("Indirect effects table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_indeff"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.481357882786616, 2.46046942401094, 1.47091365339878, 1, "ind60 <unicode> dem60 <unicode> dem65",
                                      0.00357555663623654, 0.504884670543771, 0.388355096619293, 0.388355096619293,
                                      2.91336564410754, -0.159005756964382, 1.97953264235901, 0.910263442697314,
                                      2, "ind60 <unicode> dem60 <unicode> dem65", 0.0952150456732574,
                                      0.545555534742452, 0.283169114418044, 0.283169114418044, 1.66850739242712
                                 ))
})

test_that("Factor variances table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_lvar"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.209581796157254, 0.656340332450193, "ind60", 0.432961064303724,
                                      1, "", "ind60", 0.000145359164061221, 0.11397110860631, 1, 1,
                                      3.79886683211358, 1.81562506860045, 6.88555885899737, "dem60",
                                      4.35059196379891, 1, "", "dem60", 0.000768902080228617, 1.29337422278876,
                                      0.741854994105215, 0.741854994105215, 3.3637534188815, -0.373266498808941,
                                      1.13246899862414, "dem65", 0.379601249907598, 1, "", "dem65",
                                      0.323041135528457, 0.384123256679747, 0.0611170594795115, 0.0611170594795115,
                                      0.988227719375192, 0.139438652248964, 0.510082444640648, "ind60",
                                      0.324760548444806, 2, "", "ind60", 0.000593282653738036, 0.0945537253019125,
                                      1, 1, 3.43466687756445, 1.18858916628694, 5.29026380193007,
                                      "dem60", 3.2394264841085, 2, "", "dem60", 0.00196225561471941,
                                      1.04636479751583, 0.909447740181698, 0.909447740181698, 3.09588634078595,
                                      -0.343713422100499, 0.492133643447305, "dem65", 0.0742101106734033,
                                      2, "", "dem65", 0.727819060325253, 0.213230210386736, 0.0221134944022115,
                                      0.0221134944022115, 0.348028126684339))
})

test_that("Intercepts table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_mu"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(5.11458324908891, 5.5657248590192, 5.34015405405405, 1, "", "x1",
                                      0, 0.115089260182545, 7.62813069741357, 5.34015405405405, 46.4001075824448,
                                      4.69962810017026, 5.65682865658649, 5.17822837837838, 1, "",
                                      "x2", 0, 0.244188302429663, 3.48622556023739, 5.17822837837838,
                                      21.2058822099799, 3.49123572437912, 4.39245184318845, 3.94184378378378,
                                      1, "", "x3", 0, 0.229906295706965, 2.8186923902073, 3.94184378378378,
                                      17.1454364555897, 5.06593904030224, 6.82865555429236, 5.9472972972973,
                                      1, "", "y1", 0, 0.449680843090537, 2.17427463923054, 5.9472972972973,
                                      13.2255963060892, 2.8433068923927, 5.22515797247216, 4.03423243243243,
                                      1, "", "y2", 3.1510793974121e-11, 0.607626236723531, 1.0914994882752,
                                      4.03423243243243, 6.63933218912007, 5.71017508116235, 7.79973464856738,
                                      6.75495486486486, 1, "", "y3", 0, 0.533060705167854, 2.08326693059751,
                                      6.75495486486486, 12.6720180260479, 4.36666487548171, 6.25836052992369,
                                      5.3125127027027, 1, "", "y4", 0, 0.482584289651094, 1.80978064785866,
                                      5.3125127027027, 11.0084659128535, 4.7688105944112, 6.61024886504826,
                                      5.68952972972973, 1, "", "y5", 0, 0.469763292887546, 1.99111539784612,
                                      5.68952972972973, 12.1114821355182, 1.69721605838784, 3.80307150917973,
                                      2.75014378378378, 1, "", "y6", 3.0678012175045e-07, 0.537217894666077,
                                      0.841596785005096, 2.75014378378378, 5.11923338944845, 5.40096255495844,
                                      7.38189582341994, 6.39142918918919, 1, "", "y7", 0, 0.505349405419397,
                                      2.07924353896206, 6.39142918918919, 12.6475446901631, 3.28677224232023,
                                      5.43309959551761, 4.35993591891892, 1, "", "y8", 1.77635683940025e-15,
                                      0.547542549283389, 1.30906547943098, 4.35993591891892, 7.96273444798967,
                                      0, 0, 0, 1, "", "ind60", "", 0, 0, 0, "", 0, 0, 0, 1, "", "dem60",
                                      "", 0, 0, 0, "", 0, 0, 0, 1, "", "dem65", "", 0, 0, 0, "", 4.57207725542128,
                                      4.98019327089451, 4.77613526315789, 2, "", "x1", 0, 0.104113141540458,
                                      7.44182183380898, 4.77613526315789, 45.8744707199323, 3.96560094944745,
                                      4.86703905055255, 4.41632, 2, "", "x2", 0, 0.229962924884214,
                                      3.11537917222494, 4.41632, 19.2044869938213, 2.77397157389088,
                                      3.5933194787407, 3.18364552631579, 2, "", "x3", 0, 0.209021163478697,
                                      2.47082875752998, 3.18364552631579, 15.2312113918563, 4.26909702968856,
                                      5.72037665452197, 4.99473684210526, 2, "", "y1", 0, 0.370231197175285,
                                      2.18850630331101, 4.99473684210526, 13.4908589017163, 3.23427002973367,
                                      5.71134102289791, 4.47280552631579, 2, "", "y2", 1.46083145580178e-12,
                                      0.631917477235055, 1.14822725286102, 4.47280552631579, 7.07814815612709,
                                      5.24236503773366, 7.51026812016108, 6.37631657894737, 2, "",
                                      "y3", 0, 0.578557335827686, 1.78785242699706, 6.37631657894737,
                                      11.0210625362228, 2.49773616542884, 4.73263378193958, 3.61518497368421,
                                      2, "", "y4", 2.28425278692157e-10, 0.570137419396307, 1.02862998310584,
                                      3.61518497368421, 6.34090107173139, 3.8445374644968, 5.35053095655583,
                                      4.59753421052632, 2, "", "y5", 0, 0.384189072844736, 1.94127992190524,
                                      4.59753421052632, 11.9668531342752, 2.08873924651352, 4.31127233243385,
                                      3.20000578947368, 2, "", "y6", 1.66224263242754e-08, 0.566983144448415,
                                      0.915564231279042, 3.20000578947368, 5.64391696791407, 4.97396373438813,
                                      7.03851152876977, 6.00623763157895, 2, "", "y7", 0, 0.526680033578813,
                                      1.84996647323635, 6.00623763157895, 11.4039592326413, 2.73789322525069,
                                      4.73245519580195, 3.73517421052632, 2, "", "y8", 2.1227464230833e-13,
                                      0.508826179022704, 1.19082958696493, 3.73517421052632, 7.34076658103641,
                                      0, 0, 0, 2, "", "ind60", "", 0, 0, 0, "", 0, 0, 0, 2, "", "dem60",
                                      "", 0, 0, 0, "", 0, 0, 0, 2, "", "dem65", "", 0, 0, 0, ""))
})

test_that("Regression coefficients table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_reg"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.721100887385484, 3.01873119149589, 1.86991603944068, 1, "dem60",
                                      0.00142166660030707, "ind60", 0.586140950097506, 0.508079723955586,
                                      0.508079723955586, 3.19021566251192, 0.478026990501647, 1.96570674995583,
                                      1.22186687022874, 1, "dem65", 0.00128400773281556, "ind60",
                                      0.379517116433978, 0.322601007439931, 0.322601007439931, 3.21953033820887,
                                      0.57221880758124, 1.00102151163518, 0.786620159608207, 1, "dem65",
                                      6.43485265072741e-13, "dem60", 0.109390454986999, 0.764358580570402,
                                      0.764358580570402, 7.19093964552664, -0.154169499850175, 2.14733425618151,
                                      0.996582378165669, 2, "dem60", 0.0896244560519976, "ind60",
                                      0.587129093745002, 0.300919025351176, 0.300919025351176, 1.69738203877612,
                                      -0.115343312911727, 0.965518339190619, 0.425087513139446, 2,
                                      "dem65", 0.123158203529764, "ind60", 0.275735079988215, 0.132238260924966,
                                      0.132238260924966, 1.54165191152905, 0.730849486045174, 1.0959206087116,
                                      0.913385047378385, 2, "dem65", 0, "dem60", 0.0931320997595,
                                      0.941014327982693, 0.941014327982693, 9.80741387488384))
})

test_that("Total effects table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_toteff"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(1.63130176674445, 3.75425928051059, 2.69278052362752, 1, " ind60 <unicode> dem65",
                                      6.62397930284442e-07, 0.541580746001396, 0.710956104059224,
                                      0.710956104059224, 4.9720758049633, 0.721100887385484, 3.01873119149589,
                                      1.86991603944068, 1, " ind60 <unicode> dem60", 0.00142166660030707,
                                      0.586140950097506, 0.508079723955586, 0.508079723955586, 3.19021566251192,
                                      0.57221880758124, 1.00102151163518, 0.786620159608207, 1, " dem60 <unicode> dem65",
                                      6.43485265072741e-13, 0.109390454986999, 0.764358580570402,
                                      0.764358580570402, 7.19093964552664, 0.247077278791199, 2.42362463288232,
                                      1.33535095583676, 2, " ind60 <unicode> dem65", 0.0161748412862073,
                                      0.555251874845521, 0.41540737534301, 0.41540737534301, 2.40494632495978,
                                      -0.154169499850175, 2.14733425618151, 0.996582378165669, 2,
                                      " ind60 <unicode> dem60", 0.0896244560519976, 0.587129093745002,
                                      0.300919025351176, 0.300919025351176, 1.69738203877612, 0.730849486045174,
                                      1.0959206087116, 0.913385047378385, 2, " dem60 <unicode> dem65",
                                      0, 0.0931320997595, 0.941014327982693, 0.941014327982693, 9.80741387488384
                                 ))
})

test_that("Residual variances table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_more constrained"]][["collection"]][["modelContainer_params_more constrained_var"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.01997186252367, 0.0942758067619235, "x1", 0.0571238346427967,
                                      1, "", "x1", 0.00258179957955318, 0.018955436126468, 0.116559058982616,
                                      0.0571238346427967, 3.01358587909423, -0.11906689502126, 0.14859374377243,
                                      "x2", 0.0147634243755852, 1, "", "x2", 0.828822156218448, 0.0682820299007949,
                                      0.00669168776099586, 0.0147634243755852, 0.216212441209417,
                                      0.265760017116717, 0.771730033511778, "x3", 0.518745025314248,
                                      1, "", "x3", 5.84703635451156e-05, 0.129076355582574, 0.265247007384217,
                                      0.518745025314248, 4.01890046378317, 0.416929012723992, 2.8178675599656,
                                      "y1", 1.6173982863448, 1, "", "y1", 0.00827424337844862, 0.6124955780259,
                                      0.216175504661721, 1.6173982863448, 2.64066932786314, 3.6422943641347,
                                      10.8436303032503, "y2", 7.2429623336925, 1, "", "y2", 8.06075272525852e-05,
                                      1.83710925198596, 0.530202128155924, 7.2429623336925, 3.94258660766238,
                                      1.93231536174241, 6.4194844290427, "y3", 4.17589989539255, 1,
                                      "", "y3", 0.000264281837194957, 1.14470702081633, 0.397186991478968,
                                      4.17589989539255, 3.64800758574416, 0.93173773052758, 3.96732278342862,
                                      "y4", 2.4495302569781, 1, "", "y4", 0.00156076961142482, 0.774398171814725,
                                      0.284272419056499, 2.4495302569781, 3.16314054724312, 0.731947613473432,
                                      3.17608668229298, "y5", 1.95401714788321, 1, "", "y5", 0.00172519104088487,
                                      0.623516321753513, 0.239314211823285, 1.95401714788321, 3.1338668767931,
                                      1.83678103920145, 5.92570847199075, "y6", 3.8812447555961, 1,
                                      "", "y6", 0.000198569846390884, 1.04311290029874, 0.36346982807517,
                                      3.8812447555961, 3.72082902482037, 1.19521510119158, 4.27809128408789,
                                      "y7", 2.73665319263973, 1, "", "y7", 0.000501976062955212, 0.786462457273105,
                                      0.289623983105184, 2.73665319263973, 3.47969972035094, 2.19176630693914,
                                      6.93007982455805, "y8", 4.5609230657486, 1, "", "y8", 0.000161182628549028,
                                      1.20877565990858, 0.411164182498425, 4.5609230657486, 3.7731757984716,
                                      0.0313581547372396, 0.142926262721323, "x1", 0.0871422087292811,
                                      2, "", "x1", 0.00220063448354768, 0.028461775028551, 0.211560149116582,
                                      0.0871422087292811, 3.06172783116533, -0.0362625145248565, 0.437358296920386,
                                      "x2", 0.200547891197765, 2, "", "x2", 0.0969472731767398, 0.120823855739468,
                                      0.0997973146614766, 0.200547891197765, 1.65983687551078, 0.174335809406036,
                                      0.657854185584765, "x3", 0.4160949974954, 2, "", "x3", 0.000742674694836687,
                                      0.123348791098372, 0.250627300429359, 0.4160949974954, 3.37332043378973,
                                      0.677289432337447, 2.61617514252464, "y1", 1.64673228743104,
                                      2, "", "y1", 0.000870742833370297, 0.49462279038821, 0.316150142161994,
                                      1.64673228743104, 3.3292689286286, 3.61992130179098, 10.9720172658966,
                                      "y2", 7.29596928384381, 2, "", "y2", 0.000100243055731752, 1.87556914874407,
                                      0.480815728913064, 7.29596928384381, 3.89000282326534, 2.80111563779993,
                                      8.80696575716, "y3", 5.80404069747997, 2, "", "y3", 0.000151736573070327,
                                      1.53213277558502, 0.456303755553922, 5.80404069747997, 3.78820999718107,
                                      1.47037447709157, 6.06693911088752, "y4", 3.76865679398954,
                                      2, "", "y4", 0.00130948831028244, 1.17261456589332, 0.305101189447202,
                                      3.76865679398954, 3.21389218896365, 1.06639719058275, 3.43954844740018,
                                      "y5", 2.25297281899147, 2, "", "y5", 0.000198106085773198, 0.605406853272955,
                                      0.401681970361366, 2.25297281899147, 3.72141941706049, 2.22486686950904,
                                      7.36215298125324, "y6", 4.79350992538114, 2, "", "y6", 0.000254573265779712,
                                      1.31055625314201, 0.392400667979126, 4.79350992538114, 3.65761478295103,
                                      1.879286741696, 6.17148505626852, "y7", 4.02538589898226, 2,
                                      "", "y7", 0.000236681377468129, 1.09496866994211, 0.381882902834032,
                                      4.02538589898226, 3.67625669070064, 0.346950686712702, 3.15605228468597,
                                      "y8", 1.75150148569934, 2, "", "y8", 0.0145209073086161, 0.716620718577256,
                                      0.178027879200751, 1.75150148569934, 2.44411226230897))
})


# default model covariance tables check for group 1
test_that("1 table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_covars"]][["collection"]][["modelContainer_covars_default"]][["collection"]][["modelContainer_covars_default_implied"]][["collection"]][["modelContainer_covars_default_implied_1"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.490083005636341, "", "", "", "", "", "", "", "", "", "", 0.974061924820938,
                                      2.20622852804643, "", "", "", "", "", "", "", "", "", 0.788491080043325,
                                      1.77466015582184, 1.95570584174645, "", "", "", "", "", "",
                                      "", "", 0.835178540092756, 1.8797398164842, 1.52162613108251,
                                      7.64797977172546, "", "", "", "", "", "", "", 0.9556665272501,
                                      2.15092263069126, 1.74114526494314, 6.68378929397842, 14.5127221504755,
                                      "", "", "", "", "", "", 0.788253740427642, 1.77412597456094,
                                      1.43613303237535, 5.51292920802482, 6.30825824454684, 9.62227326013949,
                                      "", "", "", "", "", 0.904244744111687, 2.03518740934666, 1.64745903478501,
                                      6.32415300473141, 9.23882105681506, 5.96882824654786, 9.02873362112342,
                                      "", "", "", "", 1.14334478995369, 2.57333087773905, 2.08307951619226,
                                      5.82366205597871, 6.32427984118542, 5.21639829184989, 5.98398776520799,
                                      7.98119516009608, "", "", "", 1.18710886159188, 2.67183085593611,
                                      2.1628140302039, 5.73848644656919, 7.58931007411125, 5.41606756969488,
                                      6.21303824196685, 6.20454284533334, 10.2893215377554, "", "",
                                      1.25970543427748, 2.83522426425122, 2.29507897323412, 6.08941841405952,
                                      6.96791532513606, 6.91162808862571, 6.59299099686961, 6.58397607191047,
                                      6.83599243915777, 9.94033521063152, "", 1.15531617741013, 2.60027492931626,
                                      2.10489039267505, 5.58480055205704, 6.39049819021455, 5.27101657115424,
                                      5.85298682041024, 6.03837521104467, 7.68811256412373, 6.65291356937699,
                                      10.6193105678442))
})

test_that("1 table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_covars"]][["collection"]][["modelContainer_covars_default"]][["collection"]][["modelContainer_covars_default_observed"]][["collection"]][["modelContainer_covars_default_observed_1"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.490082575997078, "", "", "", "", "", "", "", "", "", "", 0.973932449184952,
                                      2.20622591129467, "", "", "", "", "", "", "", "", "", 0.78518275394412,
                                      1.77565205254938, 1.95570361423433, "", "", "", "", "", "",
                                      "", "", 0.842173686632578, 1.60646357669832, 1.14904644265887,
                                      7.62580350620892, "", "", "", "", "", "", "", 0.966640855417165,
                                      2.56661076528232, 2.30600417597728, 6.02486581738495, 14.676007521986,
                                      "", "", "", "", "", "", 0.569651258731629, 1.29778304025924,
                                      0.7519816050897, 6.44636651314828, 5.79397804058276, 9.73209047934931,
                                      "", "", "", "", "", 1.07850808055391, 2.50663181045844, 2.0195628491114,
                                      6.09461043973703, 9.30788611653126, 5.64475186161118, 9.01279131583053,
                                      "", "", "", "", 1.23810412812272, 2.61063748721578, 1.81722127066318,
                                      5.59878435062089, 6.6520705502466, 5.03859665459321, 6.05661431962235,
                                      7.93189524242966, "", "", "", 1.43792308816034, 2.91763544604397,
                                      2.84145873393433, 5.38621551022644, 8.42865402090701, 4.21966332811403,
                                      6.90922843998977, 6.08535469304967, 10.3746040258343, "", "",
                                      1.04665319855464, 2.45836864046896, 1.77472198140307, 6.2463340788897,
                                      7.67698969559927, 6.7341948942526, 7.01801387855084, 6.81611022694302,
                                      6.30443702471928, 9.78003437719123, "", 1.23565159843141, 2.65937421505933,
                                      1.72765599854139, 5.4174694403214, 7.39753077439182, 4.59181056574472,
                                      6.45111697395995, 5.63862367744565, 7.72100725388949, 6.57011319209561,
                                      10.545706988345))
})


test_that("1 table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_covars"]][["collection"]][["modelContainer_covars_default"]][["collection"]][["modelContainer_covars_default_residual"]][["collection"]][["modelContainer_covars_default_residual_1"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(-4.29639262722326e-07, "", "", "", "", "", "", "", "", "", "",
                                      -0.000129475635985754, -2.6167517583886e-06, "", "", "", "",
                                      "", "", "", "", "", -0.00330832609920539, 0.000991896727537744,
                                      -2.22751211897965e-06, "", "", "", "", "", "", "", "", 0.00699514653982192,
                                      -0.27327623978588, -0.372579688423637, -0.0221762655165412,
                                      "", "", "", "", "", "", "", 0.0109743281670655, 0.415688134591064,
                                      0.56485891103414, -0.658923476593472, 0.16328537151047, "",
                                      "", "", "", "", "", -0.218602481696013, -0.476342934301694,
                                      -0.684151427285654, 0.933437305123464, -0.514280203964078, 0.10981721920982,
                                      "", "", "", "", "", 0.17426333644222, 0.471444401111772, 0.37210381432639,
                                      -0.229542564994381, 0.0690650597162001, -0.324076384936683,
                                      -0.0159423052928904, "", "", "", "", 0.0947593381690282, 0.0373066094767256,
                                      -0.265858245529077, -0.224877705357818, 0.327790709061186, -0.177801637256686,
                                      0.0726265544143585, -0.0492999176664268, "", "", "", 0.250814226568451,
                                      0.245804590107868, 0.67864470373043, -0.352270936342745, 0.83934394679576,
                                      -1.19640424158085, 0.696190198022921, -0.119188152283667, 0.0852824880789473,
                                      "", "", -0.213052235722839, -0.376855623782266, -0.520356991831051,
                                      0.156915664830179, 0.709074370463213, -0.17743319437311, 0.425022881681229,
                                      0.232134155032551, -0.53155541443849, -0.16030083344029, "",
                                      0.0803354210212781, 0.0590992857430699, -0.37723439413366, -0.16733111173564,
                                      1.00703258417727, -0.67920600540952, 0.598130153549713, -0.399751533599017,
                                      0.0328946897657652, -0.0828003772813819, -0.073603579499224
                                 ))
})

test_that("1 table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_covars"]][["collection"]][["modelContainer_covars_default"]][["collection"]][["modelContainer_covars_default_stdres"]][["collection"]][["modelContainer_covars_default_stdres_1"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(-4.29639262722326e-07, "", "", "", "", "", "", "", "", "", "",
                                      -0.9060620509028, -2.6167517583886e-06, "", "", "", "", "",
                                      "", "", "", "", -0.386009809456628, 1.26765266846776, -2.22751211897965e-06,
                                      "", "", "", "", "", "", "", "", 0.0846242017037104, -1.78626926801871,
                                      -1.50899731338325, -0.979353662951696, "", "", "", "", "", "",
                                      "", 0.0462187188848004, 0.91510411685768, 1.26724625016894,
                                      -3.1061390877585, 1.19239959132506, "", "", "", "", "", "",
                                      -1.56053141398549, -1.9857167211822, -1.9527355831674, 3.4813985041659,
                                      -0.952297065273916, 1.24738002520413, "", "", "", "", "", 1.70227576368341,
                                      2.48446501830487, 1.72887724327009, -2.99331507437673, 0.771585871131433,
                                      -1.33482628389661, -0.761717885856068, "", "", "", "", 1.47327037945439,
                                      0.272709782087367, -1.29757118956185, -2.40643758667, 0.874896574845803,
                                      -0.503887231903609, 0.37603567535386, -2.13674122503159, "",
                                      "", "", 2.35212346611509, 1.25498978664378, 3.03360225283525,
                                      -1.19107613633595, 2.12597830042828, -2.99704518860994, 2.32847953539746,
                                      -0.590849981828658, 0.80444014644474, "", "", -2.69577565127534,
                                      -2.24649212532582, -1.71719477088293, 0.644131212413233, 1.49678459768839,
                                      -0.98716825331695, 1.96201526731965, 1.27341637632093, -2.11609347217155,
                                      -2.41207540474613, "", 0.623012707174326, 0.275105560993087,
                                      -1.61236921599312, -0.529375302615407, 1.4412554289476, -1.29066565900695,
                                      2.49936790364071, -2.14139792711848, 0.273074594418215, -0.249446746350653,
                                      -2.59387512655443))
})


# bootstrapping works
options <- jaspTools::analysisOptions("SEM")
options$models <- list(list(name = "Model1", syntax = list(model = "x1 ~ x2 + x3 + y1", columns = c("x1", "x2", "x3", "y1"))))
options$emulation         <- "lavaan"
options$estimator         <- "default"
options$group             <- ""
options$samplingWeights   <- ""
options$informationMatrix <- "expected"
options$naAction          <- "fiml"
options$modelTest         <- "standard"
options$errorCalculationMethod    <- "bootstrap"
options$bootstrapCiType   <- "percentile"
options$bootstrapSamples  <- 100

set.seed(1)
results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)

# Model fit table results match
test_that("Bootstrapping model fit table works", {

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(48.156355426345, 59.7437959940266, 9.99200722162641e-14, "", "Model1",
                                      75, 0, 5, 5))
})

# Residual covariances table results match
test_that("Bootstrapping residual covariances work", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_cov"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(1.782009228184, 1.782009228184, 1.782009228184, "", "x2 - x3",
                                      "", 0, "", 1.2564136096, 1.2564136096, 1.2564136096, "", "x2 - y1",
                                      "", 0, "", 0.899301179999998, 0.899301179999998, 0.899301179999998,
                                      "", "x3 - y1", "", 0, ""),
                                 label = "Residual covariances table results match")
})


# Regression coefficients table results match
test_that("Bootstrapping regression coefficients work", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_reg"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.249609316197927, 0.447867152439518, 0.355178154406208, "x1",
                                      3.13082892944294e-14, "x2", 0.0467810932812294, 7.59234403247094,
                                      -0.0367153099343007, 0.19997796482335, 0.0779182667327594, "x1",
                                      0.112759784761359, "x3", 0.0491315895805092, 1.58590974560428,
                                      0.00301905711375345, 0.056769954444189, 0.0306885894512192,
                                      "x1", 0.0358943944804584, "y1", 0.014626696431825, 2.09812171834281
                                 ),
                                 label = "Regression coefficients table results match")
})


# Residual variances table results match
test_that("Bootstrapping residual variances work", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_var"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.0579281075433616, 0.121472727074924, "x1", 0.097380852992327,
                                      "", "x1", 9.14129882900738e-10, 0.0159022267032121, 6.12372435695794,
                                      2.25167664969695, 2.25167664969695, "x2", 2.25167664969695,
                                      "", "x2", "", 0, "", 1.94967853807201, 1.94967853807201, "x3",
                                      1.94967853807201, "", "x3", "", 0, "", 6.78685155555555, 6.78685155555555,
                                      "y1", 6.78685155555555, "", "y1", "", 0, ""),
                                 label = "Residual variances table results match")
})



test_that("t-size RMSEA and CFI match values of original article (Katerina M. Marcoulides & Ke-Hai Yuan (2017)),
          also checks vaariance-coavriance matrix input", {
  options <- jaspTools::analysisOptions("SEM")
  options$sampleSize <- 600
  options$samplingWeights <- ""
  options$additionalFitMeasures <- TRUE
  options$informationMatrix <- "expected"
  options$estimator <- "default"
  options$modelTest <- "standard"
  options$naAction <- "fiml"
  options$emulation <- "mplus"
  options$group <- ""
  options$dataType <- "varianceCovariance"
  options$models <- list(list(name = "Model1", syntax = list(model = "factor1 =~ V1 + V2 + V3 + V4 + V5 + V6 + V7\n factor2 =~ V8 + V9 + V10 + V11 + V12",
                                                             columns = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12"))))
  set.seed(1)
  dataset <- structure(list(V1 = c(1.321, 0.443, 0.283, 0.379, 0.462, 0.316, 0.392, 0.404, 0.398, 0.313, 0.374, 0.381),
                            V2 = c(0.443, 1.41, 0.507, 0.526, 0.466, 0.392, 0.404, 0.342, 0.493, 0.423, 0.448, 0.486),
                            V3 = c(0.283, 0.507, 1.485, 0.542, 0.411, 0.37, 0.352, 0.389, 0.437, 0.372, 0.359, 0.387),
                            V4 = c(0.379, 0.526, 0.542, 1.547, 0.527, 0.418, 0.481, 0.449, 0.45, 0.379, 0.368, 0.359),
                            V5 = c(0.462, 0.466, 0.411, 0.527, 1.524, 0.496, 0.478, 0.426, 0.447, 0.398, 0.348, 0.37),
                            V6 = c(0.316, 0.392, 0.37, 0.418, 0.496, 1.441, 0.387, 0.391, 0.48, 0.3, 0.404, 0.438),
                            V7 = c(0.392, 0.404, 0.352, 0.481, 0.478, 0.387, 1.422, 0.405, 0.412, 0.351, 0.335, 0.371),
                            V8 = c(0.404, 0.342, 0.389, 0.449, 0.426, 0.391, 0.405, 1.566, 0.657, 0.538, 0.591, 0.556),
                            V9 = c(0.398,0.493, 0.437, 0.45, 0.447, 0.48, 0.412, 0.657, 1.646, 0.599, 0.608, 0.69),
                            V10 = c(0.313, 0.423, 0.372, 0.379, 0.398, 0.3, 0.351, 0.538, 0.599, 1.675, 0.659, 0.529),
                            V11 = c(0.374, 0.448, 0.359, 0.368, 0.348, 0.404, 0.335, 0.591, 0.608, 0.659, 1.63, 0.64),
                            V12 = c(0.381, 0.486, 0.387, 0.359, 0.37, 0.438, 0.371, 0.556, 0.69, 0.529, 0.64, 1.673)),
                       class = "data.frame", row.names = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12"))
  results <- jaspTools::runAnalysis("SEM", dataset, options)

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_addfit"]][["collection"]][["modelContainer_addfit_incrits"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list("Log-likelihood", -10988.8301074082, "Number of free parameters",
                                      25, "Akaike (AIC)", 22027.6602148165, "Bayesian (BIC)", 22137.5834561969,
                                      "Sample-size adjusted Bayesian (SSABIC)", 22058.2153051905))

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_addfit"]][["collection"]][["modelContainer_addfit_indices"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list("Comparative Fit Index (CFI)", 0.996320596799055, "T-size CFI",
                                      0.974924004613834, "Tucker-Lewis Index (TLI)", 0.995418101674295,
                                      "Bentler-Bonett Non-normed Fit Index (NNFI)", 0.995418101674295,
                                      "Bentler-Bonett Normed Fit Index (NFI)", 0.961983689254605,
                                      "Parsimony Normed Fit Index (PNFI)", 0.772502053492334, "Bollen's Relative Fit Index (RFI)",
                                      0.952658933788753, "Bollen's Incremental Fit Index (IFI)", 0.996352840580171,
                                      "Relative Noncentrality Index (RNI)", 0.996320596799055))

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_addfit"]][["collection"]][["modelContainer_addfit_others"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list("Root mean square error of approximation (RMSEA)", 0.0130437119173581,
                                      "RMSEA 90% CI lower bound", 0, "RMSEA 90% CI upper bound", 0.0297980428058939,
                                      "RMSEA p-value", 0.999994986450328, "T-size RMSEA", 0.029823208611982,
                                      "Standardized root mean square residual (SRMR)", 0.0253510370222869,
                                      "Hoelter's critical N (<unicode> = .05)", 730.254899918116,
                                      "Hoelter's critical N (<unicode> = .01)", 821.162187177968,
                                      "Goodness of fit index (GFI)", 0.984016681585093, "McDonald fit index (MFI)",
                                      0.995501480640541, "Expected cross validation index (ECVI)",
                                      0.180684002957667))
})


test_that("Variance-covariance input works", {
  options <- jaspTools::analysisOptions("SEM")
  options$dataType          <- "varianceCovariance"
  options$sampleSize        <- 75
  options$emulation         <- "lavaan"
  options$estimator         <- "default"
  options$group             <- ""
  options$samplingWeights   <- ""
  options$informationMatrix <- "expected"
  options$naAction          <- "fiml"
  options$modelTest         <- "standard"
  options$models <- list(
    list(name = "Model1", syntax = list(model = "F =~ x1 + x3 + y1", columns = c("x1", "x2", "x3"))),
    list(name = "Model2", syntax = list(model = "F =~ y1 + y2 + y3", columns = c("y1", "y2", "y3")))
  )

  data <- read.csv("poldem_grouped.csv")
  # data <- read.csv("tests/testthat/poldem_grouped.csv")
  data <- cov(data)
  data <- as.data.frame(data)

  set.seed(1)
  results <- jaspTools::runAnalysis("SEM", data, options)
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(707.570148255052, 721.47507693627, 6.66133814775094e-14, 0, "Model1",
                                      75, "", "", "", "", 6, 6, 1095.63355300897, 1109.53848169019,
                                      0, 0, "Model2", 75, "", "", -6.66133814775094e-14, 0, 6, 6
                                 ))
})


test_that("Fixing mean manifest intercepts works", {
  options <- jaspTools::analysisOptions("SEM")
  options$models <- list(list(name = "Model1", syntax = list(model = "factor =~ x2 + x3 + y1 + x1", columns = c("x1", "x2", "x3", "y1"))))
  options$emulation         <- "lavaan"
  options$estimator         <- "default"
  options$meanStructure     <- TRUE
  options$manifestMeanFixedToZero <- TRUE
  options$group             <- "group"
  options$samplingWeights   <- ""
  options$informationMatrix <- "expected"
  options$naAction          <- "fiml"
  options$modelTest         <- "standard"

  set.seed(1)

  results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_mu"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(-3.0031653252094, -0.238164753555845, -1.62066503938262, 1, "",
                                      "x2", 0.0215840525894235, 0.705370250031003, -2.29760900649183,
                                      -2.90748296601922, -0.257527727837225, -1.58250534692822, 1,
                                      "", "x3", 0.0192367987813871, 0.676021411384215, -2.34091009586205,
                                      -2.02601609127232, 3.81817181538369, 0.896077862055687, 1, "",
                                      "y1", 0.547816766514775, 1.49089165738611, 0.601034862336494,
                                      1.63165251250819, 2.98253253600213, 2.30709252425516, 1, "",
                                      "x1", 2.16224815829946e-11, 0.344618583338652, 6.6946259888371,
                                      5.33697746290641, 8.26080927533766, 6.79889336912203, 1, "",
                                      "factor", 0, 0.745889168243412, 9.11515230222956, -4.07239223241945,
                                      -0.696581025547053, -2.38448662898325, 2, "", "x2", 0.00562595928754916,
                                      0.861192152891677, -2.76882066444372, -3.8707672830057, -0.886230339808109,
                                      -2.37849881140691, 2, "", "x3", 0.00178440810521097, 0.761375455554092,
                                      -3.12394994356096, -0.553574385842091, 6.22823829704087, 2.83733195559939,
                                      2, "", "y1", 0.101006267898262, 1.73008604657459, 1.63999470501311,
                                      1.12212007800144, 2.7291868915801, 1.92565348479077, 2, "",
                                      "x1", 2.63986228365987e-06, 0.409973557232427, 4.69701874869713,
                                      5.05992393096499, 8.54168933431517, 6.80080663264008, 2, "",
                                      "factor", 1.90958360235527e-14, 0.88822178132198, 7.65665374983052
                                 ))
})


# multigroup sem with clickable equality constraints
options <- jaspTools::analysisOptions("SEM")
options$emulation                   = "lavaan"
options$estimator                   = "default"
options$group                       = "group"
options$informationMatrix           = "expected"
options$naAction                    = "listwise"
options$modelTest                   = "default"
options$equalLatentVariance <- TRUE
options$equalThreshold <- TRUE
options$equalResidualCovariance <- TRUE
options$samplingWeights             = ""

modelDefault <- list(model = "
  # latent variable definitions
    ind60 =~ x1 + x2 + x3
    dem60 =~ y1 + y2 + y3 + y4
    dem65 =~ y5 + y6 + y7 + y8
  # regressions
    dem60 ~ ind60
    dem65 ~ ind60 + dem60
  # residual (co)variances
    y1 ~~ y5
    y2 ~~ y4 + y6
    y3 ~~ y7
    y4 ~~ y8
    y6 ~~ y8
  ", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))

options$models = list(
  list(name = "default", syntax = modelDefault)
)

results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)


test_that("Residual covariances table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_cov"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(-0.00951791257482959, 1.24816024605178, 0.619321166738473, 1,
                                      ".p15.", "y1 - y5", 0.0535698529369328, 0.320842160505757, 1.93029857971973,
                                      0.275192537634027, 2.86800908936388, 1.57160081349895, 1, ".p16.",
                                      "y2 - y4", 0.0175009166166575, 0.661444948014774, 2.37601151572156,
                                      0.268525824232089, 2.7211595743112, 1.49484269927165, 1, ".p17.",
                                      "y2 - y6", 0.0168880472594957, 0.625683372098972, 2.38913604856865,
                                      -0.133131830969623, 2.16082046556287, 1.01384431729662, 1, ".p18.",
                                      "y3 - y7", 0.0831904444650153, 0.585202665617047, 1.73246701846037,
                                      -0.317356322859665, 1.22820518019921, 0.455424428669772, 1,
                                      ".p19.", "y4 - y8", 0.248061966101383, 0.394283138682666, 1.15506950206236,
                                      -0.107502588115688, 1.92491220954654, 0.908704810715428, 1,
                                      ".p20.", "y6 - y8", 0.0796666998015847, 0.518482689910034, 1.75262323776538,
                                      -0.00951791257482848, 1.24816024605178, 0.619321166738474, 2,
                                      ".p15.", "y1 - y5", 0.0535698529369324, 0.320842160505757, 1.93029857971974,
                                      0.275192537634027, 2.86800908936388, 1.57160081349895, 2, ".p16.",
                                      "y2 - y4", 0.0175009166166575, 0.661444948014774, 2.37601151572156,
                                      0.268525824232089, 2.7211595743112, 1.49484269927165, 2, ".p17.",
                                      "y2 - y6", 0.0168880472594957, 0.625683372098972, 2.38913604856865,
                                      -0.133131830969623, 2.16082046556287, 1.01384431729662, 2, ".p18.",
                                      "y3 - y7", 0.0831904444650153, 0.585202665617047, 1.73246701846037,
                                      -0.317356322859664, 1.22820518019921, 0.455424428669772, 2,
                                      ".p19.", "y4 - y8", 0.248061966101383, 0.394283138682666, 1.15506950206236,
                                      -0.107502588115688, 1.92491220954654, 0.908704810715428, 2,
                                      ".p20.", "y6 - y8", 0.0796666998015847, 0.518482689910034, 1.75262323776538
                                 ))
})

test_that("Factor Loadings table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_ind"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(1, 1, 1, 1, "", "dem60", "", "y1", 0, "", 0.756011678010104, 1.67072819069569,
                                      1.2133699343529, 1, "", "dem60", 1.9952676000301e-07, "y2",
                                      0.233350337021689, 5.19977793835421, 0.589605318467516, 1.32872910566561,
                                      0.959167212066564, 1, "", "dem60", 3.63917969981031e-07, "y3",
                                      0.188555451280791, 5.08692379642846, 0.805825133517716, 1.44228139685688,
                                      1.1240532651873, 1, "", "dem60", 4.42068603945245e-12, "y4",
                                      0.162364275149812, 6.92303318664248, 1, 1, 1, 1, "", "dem65",
                                      "", "y5", 0, "", 0.700926359250009, 1.43830977067363, 1.06961806496182,
                                      1, "", "dem65", 1.29983670493772e-08, "y6", 0.18811146971067,
                                      5.68608637531234, 0.772761413508819, 1.46047960799357, 1.11662051075119,
                                      1, "", "dem65", 1.95760740950846e-10, "y7", 0.175441538699023,
                                      6.36463017271413, 0.624931701232413, 1.39554577224672, 1.01023873673957,
                                      1, "", "dem65", 2.76438375079735e-07, "y8", 0.196588834563496,
                                      5.13884086541687, 1, 1, 1, 1, "", "ind60", "", "x1", 0, "",
                                      1.96896816200596, 2.59152950311334, 2.28024883255965, 1, "",
                                      "ind60", 0, "x2", 0.158819586997022, 14.3574786691921, 1.41188756682593,
                                      2.28258726764383, 1.84723741723488, 1, "", "ind60", 0, "x3",
                                      0.222121352148783, 8.31634329327129, 1, 1, 1, 2, "", "dem60",
                                      "", "y1", 0, "", 0.946873365788966, 1.95400766095123, 1.4504405133701,
                                      2, "", "dem60", 1.64848641404092e-08, "y2", 0.256926735161057,
                                      5.64534676572633, 0.693457886245215, 1.60751683650406, 1.15048736137464,
                                      2, "", "dem60", 8.06253452667605e-07, "y3", 0.233182588422242,
                                      4.93384763055875, 0.985835136390041, 1.80735761387033, 1.39659637513018,
                                      2, "", "dem60", 2.6662450025583e-11, "y4", 0.209575911588261,
                                      6.66391649949722, 1, 1, 1, 2, "", "dem65", "", "y5", 0, "",
                                      0.990824643773827, 2.24686561848509, 1.61884513112946, 2, "",
                                      "dem65", 4.36775339229811e-07, "y6", 0.320424503873223, 5.05218892925231,
                                      1.02335110163161, 2.23722284550416, 1.63028697356788, 2, "",
                                      "dem65", 1.40458174646696e-07, "y7", 0.309666849352186, 5.26464804669404,
                                      1.1798456720653, 2.29947786139703, 1.73966176673116, 2, "",
                                      "dem65", 1.12414877406763e-09, "y8", 0.285625704901529, 6.09070450200173,
                                      1, 1, 1, 2, "", "ind60", "", "x1", 0, "", 1.84998352886442,
                                      2.73263225194019, 2.2913078904023, 2, "", "ind60", 0, "x2",
                                      0.225169628125308, 10.1759189704181, 1.46115134483908, 2.34512680229753,
                                      1.90313907356831, 2, "", "ind60", 0, "x3", 0.225508086993215,
                                      8.43933846871561))
})

test_that("Factor variances table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_lvar"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.236834368913409, 0.526943426776363, "ind60", 0.381888897844886,
                                      1, ".p32.", "ind60", 2.46885135668506e-07, 0.0740087726487062,
                                      5.16004906144815, 2.10074625444669, 5.55500000431209, "dem60",
                                      3.82787312937939, 1, ".p33.", "dem60", 1.39965271599429e-05,
                                      0.881203373406886, 4.34391565545212, -0.163743825408124, 0.471589188522818,
                                      "dem65", 0.153922681557347, 1, ".p34.", "dem65", 0.342272660831397,
                                      0.162077726668033, 0.949684356522418, 0.236834368913409, 0.526943426776364,
                                      "ind60", 0.381888897844886, 2, ".p32.", "ind60", 2.46885135668506e-07,
                                      0.0740087726487062, 5.16004906144815, 2.10074625444669, 5.55500000431209,
                                      "dem60", 3.82787312937939, 2, ".p33.", "dem60", 1.39965271599429e-05,
                                      0.881203373406886, 4.34391565545212, -0.163743825408123, 0.471589188522818,
                                      "dem65", 0.153922681557347, 2, ".p34.", "dem65", 0.342272660831395,
                                      0.162077726668033, 0.949684356522422))
})

test_that("Regression coefficients table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_reg"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.74768461194592, 3.13257692292812, 1.94013076743702, 1, "dem60",
                                      0.00142817392050287, "ind60", 0.608402075189629, 3.18889570985161,
                                      0.348414558253314, 1.77200632968998, 1.06021044397165, 1, "dem65",
                                      0.0035077327559101, "ind60", 0.363167839477097, 2.91934011970383,
                                      0.561449579948802, 1.07483914739603, 0.818144363672416, 1, "dem65",
                                      4.188163149621e-10, "dem60", 0.130969132978152, 6.24684874266441,
                                      -0.159200803124074, 2.11012259112266, 0.975460893999292, 2,
                                      "dem60", 0.0919948186806887, "ind60", 0.578919666929308, 1.68496762110935,
                                      -0.060427080504905, 0.893216563537904, 0.4163947415165, 2, "dem65",
                                      0.0869740956449763, "ind60", 0.243280910150653, 1.7115800054293,
                                      0.520132317569988, 1.00885279137076, 0.764492554470373, 2, "dem65",
                                      8.68684457699942e-10, "dem60", 0.124675881203873, 6.13183999253438
                                 ))
})

test_that("Residual variances table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_var"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.0203903214908377, 0.0937153039795448, "x1", 0.0570528127351912,
                                      1, "", "x1", 0.00228823496004704, 0.0187056963972515, 3.05002345400914,
                                      -0.118209788938257, 0.149904178675381, "x2", 0.0158471948685619,
                                      1, "", "x2", 0.816777242474263, 0.0683976771329697, 0.231692003776004,
                                      0.265272329814418, 0.77118752500936, "x3", 0.518229927411889,
                                      1, "", "x3", 5.93589306818743e-05, 0.129062370325561, 4.0153448763156,
                                      0.955937394672428, 3.44425722642889, "y1", 2.20009731055066,
                                      1, "", "y1", 0.000528495119347161, 0.63478713164732, 3.46588202700525,
                                      3.66970107786074, 9.74166689190863, "y2", 6.70568398488469,
                                      1, "", "y2", 1.49759018457374e-05, 1.54899933415685, 4.3290425224971,
                                      2.27047423539234, 6.74954147085745, "y3", 4.51000785312489,
                                      1, "", "y3", 7.91345249973041e-05, 1.1426401890023, 3.94700614990867,
                                      0.808965794775632, 3.41798227151407, "y4", 2.11347403314485,
                                      1, "", "y4", 0.00149631062392186, 0.66557765788505, 3.17539810434842,
                                      1.11694253229257, 3.50064331730598, "y5", 2.30879292479928,
                                      1, "", "y5", 0.000146608976578477, 0.608098108897852, 3.79674412897592,
                                      2.01550902816011, 5.70617179577256, "y6", 3.86084041196633,
                                      1, "", "y6", 4.11943023612693e-05, 0.941512904503329, 4.1006771054328,
                                      1.24180041617095, 4.19509083800568, "y7", 2.71844562708831,
                                      1, "", "y7", 0.000308309240888649, 0.753404257713385, 3.60821643793057,
                                      2.48138223648679, 6.90158475152541, "y8", 4.6914834940061, 1,
                                      "", "y8", 3.17543815182564e-05, 1.12762340275245, 4.16050561078682,
                                      0.029510673036908, 0.141539110406694, "x1", 0.0855248917218009,
                                      2, "", "x1", 0.00276651561179819, 0.0285792081521528, 2.99255638107519,
                                      -0.0267791677359907, 0.438546862055045, "x2", 0.205883847159527,
                                      2, "", "x2", 0.0828515610609226, 0.118707801128354, 1.73437503856139,
                                      0.176021005738021, 0.655774374392718, "x3", 0.415897690065369,
                                      2, "", "x3", 0.000678354170778217, 0.12238831234628, 3.39818142837566,
                                      0.574750605514609, 2.32900512597363, "y1", 1.45187786574412,
                                      2, "", "y1", 0.00117756468638741, 0.44752213160455, 3.24425936330466,
                                      3.6870584232221, 9.87516092384412, "y2", 6.78110967353311, 2,
                                      "", "y2", 1.74240725272501e-05, 1.57862658432323, 4.29557549636745,
                                      3.2208970735798, 9.03569722755529, "y3", 6.12829715056754, 2,
                                      "", "y3", 3.60771566090268e-05, 1.48339464394292, 4.13126552370331,
                                      1.74649287998714, 5.53471771963364, "y4", 3.64060529981039,
                                      2, "", "y4", 0.000165104461237187, 0.966401645521942, 3.76717622189492,
                                      1.12693384686582, 3.23414942031535, "y5", 2.18054163359059,
                                      2, "", "y5", 4.98493706548864e-05, 0.537564871107577, 4.05633208341514,
                                      2.42234871563612, 6.77525180716898, "y6", 4.59880026140255,
                                      2, "", "y6", 3.45243234869397e-05, 1.1104548669945, 4.14136620775002,
                                      1.93723745179962, 6.03541205409186, "y7", 3.98632475294574,
                                      2, "", "y7", 0.000137321827685, 1.04547191545817, 3.81294293419518,
                                      0.313473463282918, 2.61122637106262, "y8", 1.46234991717277,
                                      2, "", "y8", 0.0126047867836248, 0.586172227118478, 2.494744461643
                                 ))
})


# Sensitivity analysis works
options <- analysisOptions("SEM")
options$samplingWeights <- ""
options$sensitivityAnalysis <- TRUE
options$sizeOfSolutionArchive <- 10
options$maxIterations <- 10
options$informationMatrix <- "expected"
options$estimator <- "default"
options$modelTest <- "standard"
options$emulation <- "lavaan"
options$group <- ""
options$setSeed <- TRUE
options$seed <- 1
model <- "
# latent variable definitions
ind60 =~ x1 + x2 + x3
dem60 =~ y1 + y2 + y3 + y4
dem65 =~ y5 + y6 + y7 + y8
# regressions
dem60 ~ ind60
dem65 ~ ind60 + dem60
# residual (co)variances
y1 ~~ y5
y2 ~~ y4 + y6
y3 ~~ y7
y4 ~~ y8
y6 ~~ y8
"
options$models <- list(list(name = "Model1",
                            syntax = list(model=model,
                                          columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))))
set.seed(1)
results <- runAnalysis("SEM", "poldem_grouped.csv", options)

test_that("Sensitivity parameters that led to a change in significance table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_sensitivity"]][["collection"]][["modelContainer_sensitivity_senpar"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.163825629932947, -0.00736627172133829, 1.83420695785249, "dem60~ind60",
                                      0.136451103548822, -0.356128009622868, -0.859719801919833, "dem65~ind60"
                                 ))
})

test_that("Summary of sensitivity analysis table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_sensitivity"]][["collection"]][["modelContainer_sensitivity_sensum"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.446712905437343, 0.773905343716094, 0.379067079696325, -0.0960469939853047,
                                      "dem60~ind60", 1.54185576191068e-05, 0.243857952730406, 0.885228943292037,
                                      1.20492628703677, 0.894340089736308, 0.770806763710209, "dem65~dem60",
                                      0, "", 0.182259409976201, 0.380588637180451, 0.0646300844286729,
                                      -0.56059414912222, "dem65~ind60", 0.00967602063729744, 0.125746802403301
                                 ))
})

test_that("Summary of sensitivity parameters table results match", {
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_sensitivity"]][["collection"]][["modelContainer_sensitivity_sensumpar"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.332587428764211, 0.0594414507904125, -0.268377141254013, "dem60~phantom",
                                      0.467843048994546, 0.0319319696951054, -0.462805738408711, "dem65~phantom",
                                      2.16041463170958, 0.508721525156672, -1.30877622339889, "ind60~phantom"
                                 ))
})
