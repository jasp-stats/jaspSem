context("Structural Equation Modeling")

test_that("Basic SEM works", {
  options <- jaspTools::analysisOptions("SEM")
  options$models <- list(list(name = "Model1", syntax = list(model = "x1 ~ x2 + x3 + y1", columns = c("x1", "x2", "x3", "y1"))))
  options$emulation         <- "lavaan"
  options$estimator         <- "default"
  options$group             <- ""
  options$samplingWeights   <- ""
  options$informationMatrix <- "expected"
  options$naAction          <- "fiml"
  options$modelTest         <- "standard"
  options$errorCalculationMethod <- "standard"
  options$ciLevel           <- 0.95
  results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)

  fittab   <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  expect_equal_tables(fittab, list(48.1563554263441, 59.7437959940257, 0, 0, "Model1", 75, 1, 0,
                                   0, ""), "Model fit table")

  parcont <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]]
  parcov  <- parcont[["modelContainer_params_cov"]][["data"]]
  parreg  <- parcont[["modelContainer_params_reg"]][["data"]]
  parvar  <- parcont[["modelContainer_params_var"]][["data"]]

  expect_equal_tables(parcov, list(1.782009228184, 1.782009228184, 1.782009228184, "", "x2 - x3",
                                   "", 0, "", 1.2564136096, 1.2564136096, 1.2564136096, "", "x2 - y1",
                                   "", 0, "", 0.899301179999998, 0.899301179999998, 0.899301179999998,
                                   "", "x3 - y1", "", 0, ""),
                      "Covariance parameter table")
  expect_equal_tables(parreg, list(0.26348889641759, 0.446867412394827, 0.355178154406208, "", "x1",
                                   3.13082892944294e-14, "x2", 0.0467810932812294, 7.59234403247094,
                                   -0.018377879348242, 0.174214412813761, 0.0779182667327594, "",
                                   "x1", 0.112759784761359, "x3", 0.0491315895805092, 1.58590974560428,
                                   0.00202079123204174, 0.0593563876703967, 0.0306885894512192,
                                   "", "x1", 0.0358943944804584, "y1", 0.014626696431825, 2.09812171834281),
                      "Regressions parameter table")
  expect_equal_tables(parvar, list(0.0662130628477228, 0.128548647454031, "x1", 0.0973808551508767,
                                   "", "x1", 9.14129882900738e-10, 0.0159022270557018, 6.12372435695796,
                                   2.25167664969695, 2.25167664969695, "x2", 2.25167664969695,
                                   "", "x2", "", 0, "", 1.94967853807201, 1.94967853807201, "x3",
                                   1.94967853807201, "", "x3", "", 0, "", 6.78685155555555, 6.78685155555555,
                                   "y1", 6.78685155555555, "", "y1", "", 0, ""),
                      "(Residual) variances parameter table")
})

test_that("Multigroup, multimodel SEM works", {
  options <- jaspTools::analysisOptions("SEM")
  options$emulation                   = "lavaan"
  options$estimator                   = "default"
  options$group                       = "group"
  options$informationMatrix           = "expected"
  options$meanStructure               = TRUE
  options$modificationIndexLowHidden  = TRUE
  options$naAction                    = "listwise"
  options$impliedCovariance           = TRUE
  options$mardiasCoefficient          = TRUE
  options$modificationIndex           = TRUE
  options$observedCovariance          = TRUE
  options$pathPlot                    = TRUE
  options$rSquared                    = TRUE
  options$residualCovariance          = TRUE
  options$standardizedResidual        = TRUE
  options$pathPlotParameter           = TRUE
  options$standardizedEstimate        = TRUE
  options$modelTest                   = "satorraBentler"
  options$samplingWeights             = ""
  options$errorCalculationMethod      = "standard"
  options$ciLevel                     = 0.95

  modelDefault <- list(model = "
  # latent variable definitions
    ind60 =~ x1 + x2 + x3
    dem60 =~ y1 + y2 + y3 + y4
    dem65 =~ y5 + y6 + y7 + y8
  # regressions
    dem60 ~ ind60
    dem65 ~ ind60 + dem60
  # residual (co)variances
    y1 ~~ y5
    y2 ~~ y4 + y6
    y3 ~~ y7
    y4 ~~ y8
    y6 ~~ y8
  ", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))
  modelConstrained <- list(model = "
  # latent variable definitions
    ind60 =~ x1 + x2 + x3
    dem60 =~ c(a1,a2)*y1 + c(b1,b2)*y2 + c(c1,c2)*y3 + c(d1,d2)*y4
    dem65 =~ c(a1,a3)*y5 + c(b1,b3)*y6 + c(c1,c3)*y7 + c(d1,d3)*y8
  # regressions
    dem60 ~ ind60
    dem65 ~ ind60 + dem60
  # residual (co)variances
    y1 ~~ y5
    y2 ~~ y4 + y6
    y3 ~~ y7
    y4 ~~ y8
    y6 ~~ y8
  ", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))
  modelMoreConstrained <- list(model = "
  # latent variable definitions
    ind60 =~ x1 + x2 + x3
    dem60 =~ c(a1, a2)*y1 + c(b1, b2)*y2 + c(c1, c2)*y3 + c(d1, d2)*y4
    dem65 =~ c(a1, a2)*y5 + c(b1, b2)*y6 + c(c1, c2)*y7 + c(d1, d2)*y8
  # regressions
    dem60 ~ ind60
    dem65 ~ ind60 + dem60
  # residual (co)variances
    y1 ~~ y5
    y2 ~~ y4 + y6
    y3 ~~ y7
    y4 ~~ y8
    y6 ~~ y8
  ", columns = c("x1", "x2", "x3", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8"))

  options$models = list(
    list(name = "default",          syntax = modelDefault),
    list(name = "constrained",      syntax = modelConstrained),
    list(name = "more constrained", syntax = modelMoreConstrained)
  )

  results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)

  fittab   <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  expect_equal_tables(fittab, list(3189.26691715402, 3383.93591869107, 85.6796813843018, 70, "default",
                                   75, 0.0980338951401478, "", "", "", 3184.34803034567, 3372.06456754211,
                                   87.9549367720082, 73, "constrained", 75, 0.111927575441416, 0.647754490401111,
                                   1.65156784895969, 3, 3181.07183366569, 3361.83590652152, 92.7433708195334,
                                   76, "more constrained", 75, 0.0929761753674234, 0.110596895607335,
                                   6.02091896557529, 3), "Model fit table")


  rsquared <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_rsquared"]][["data"]]
  expect_equal_tables(rsquared, list(1, "x1", 0.883076871616545, 0.88344099961725, 0.883440941017356,
                                     1, "x2", 0.993698159869737, 0.993307380054294, 0.993308312239008,
                                     1, "x3", 0.734550879193546, 0.734754000085834, 0.734752992615769,
                                     1, "y1", 0.76374604003533, 0.783825225382152, 0.783824495338428,
                                     1, "y2", 0.526988232837519, 0.469805811235219, 0.469797871843766,
                                     1, "y3", 0.540743668690899, 0.602813004892641, 0.602813008520997,
                                     1, "y4", 0.758371834315633, 0.715732725592277, 0.715727580943472,
                                     1, "y5", 0.74873567690424, 0.760689523184987, 0.760685788176897,
                                     1, "y6", 0.626089440009365, 0.636528021958327, 0.636530171924641,
                                     1, "y7", 0.729758226751308, 0.710375682244039, 0.71037601689489,
                                     1, "y8", 0.574575906571731, 0.588831799668115, 0.588835817501729,
                                     1, "dem60", 0.275927380324134, 0.258157185403394, 0.258145005894915,
                                     1, "dem65", 0.941713333219213, 0.938883931908498, 0.938882940520396,
                                     2, "x1", 0.787475869571125, 0.78747617521673, 0.788439850883342,
                                     2, "x2", 0.90066092940223, 0.900660946749863, 0.900202685338541,
                                     2, "x3", 0.749867733548725, 0.749868295135393, 0.749372699570588,
                                     2, "y1", 0.731921944773149, 0.731929437708713, 0.683849857838249,
                                     2, "y2", 0.550065444500199, 0.55006739915162, 0.519184271086883,
                                     2, "y3", 0.465824888188388, 0.465819890503162, 0.543696244446076,
                                     2, "y4", 0.651968126202522, 0.651959003998254, 0.694898810552775,
                                     2, "y5", 0.536001769615456, 0.535995620432757, 0.598318029638657,
                                     2, "y6", 0.625808175301569, 0.625823134164411, 0.607599332020539,
                                     2, "y7", 0.658946836103404, 0.658945492261667, 0.618117097165422,
                                     2, "y8", 0.842442637402788, 0.842449295416932, 0.821972120799197,
                                     2, "dem60", 0.0753599955960172, 0.0753581296999281, 0.0905522598180797,
                                     2, "dem65", 0.956917027167473, 0.956910675588687, 0.977886505597527),
                      "R-squared table")

  mardia   <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_mardiasTable"]][["data"]]
  expect_equal_tables(mardia, list(330.8978096739, 26.471824773912, 286, "Skewness", 0.0347860345067638,
                                   "", "", 134.567190822067, "", "Kurtosis", 0.0308358026617131,
                                   -2.15918518879414), "Mardia's coefficient table")

  # parameter tables (use only the most constrained one, model 3)
  parcont <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][[3]][["collection"]]

  parcov  <- parcont[["modelContainer_params_more constrained_cov"]][["data"]]
  parind  <- parcont[["modelContainer_params_more constrained_ind"]][["data"]]
  parlvar <- parcont[["modelContainer_params_more constrained_lvar"]][["data"]]
  parmu   <- parcont[["modelContainer_params_more constrained_mu"]][["data"]]
  parreg  <- parcont[["modelContainer_params_more constrained_reg"]][["data"]]
  parvar  <- parcont[["modelContainer_params_more constrained_var"]][["data"]]

  expect_equal_tables(parcov, list(-0.358864175061026, 0.603322975607222, 0.122229400273098, 1, "",
                                   "y1 - y5", 0.618512432703301, 0.245460416175465, 0.497959720665199,
                                   0.298874362508266, 0.804248641865253, 0.551561502186759, 1,
                                   "", "y2 - y4", 1.88428924210449e-05, 0.128924379055767, 4.27817846575145,
                                   -0.0660654533800169, 0.453186076172267, 0.193560311396125, 1,
                                   "", "y2 - y6", 0.143954147093079, 0.132464558953142, 1.46122338628398,
                                   -0.0394544938310216, 0.656258060667344, 0.308401783418161, 1,
                                   "", "y3 - y7", 0.0822705129625882, 0.177480953728246, 1.7376612923231,
                                   -0.354330258792462, 0.243417993430552, -0.055456132680955, 1,
                                   "", "y4 - y8", 0.71610327532265, 0.152489601068687, -0.363671570338594,
                                   0.0350963481019102, 0.655763541072373, 0.345429944587142, 1,
                                   "", "y6 - y8", 0.029137525351109, 0.158336377062591, 2.18162086941394,
                                   0.0448493338646443, 0.712995826486632, 0.378922580175638, 2,
                                   "", "y1 - y5", 0.0262097889470547, 0.170448665866374, 2.22308915267604,
                                   -0.030207746781852, 0.574856694071005, 0.272324473644576, 2,
                                   "", "y2 - y4", 0.0776878450894229, 0.154356010014859, 1.76426219891509,
                                   0.0810795942211756, 0.625128960139662, 0.353104277180419, 2,
                                   "", "y2 - y6", 0.0109543952352742, 0.138790653861469, 2.54415025332227,
                                   -0.269314190696169, 0.474306410514885, 0.102496109909358, 2,
                                   "", "y3 - y7", 0.588990939952761, 0.189702618792141, 0.540298866520466,
                                   -0.0855863559048741, 0.66509268796883, 0.289753166031978, 2,
                                   "", "y4 - y8", 0.130268104986451, 0.191503275007848, 1.51304548718607,
                                   -0.0312697825094981, 0.654724621826752, 0.311727419658627, 2,
                                   "", "y6 - y8", 0.0748665014821734, 0.175001788233684, 1.78128133892193), "Covariance parameter table")
  expect_equal_tables(parind, list(0.789134641892047, 0.981542624397242, 0.885338633144645, 1, "a1",
                                   "dem60", 0, "y1", 0.049084570946937, 18.0370046241566, 0.527821385977255,
                                   0.843014668179136, 0.685418027078195, 1, "b1", "dem60", 0, "y2",
                                   0.0804079270558249, 8.52425938803682, 0.641994892877322, 0.910825777413999,
                                   0.776410335145661, 1, "c1", "dem60", 0, "y3", 0.0685805674637851,
                                   11.3211418898751, 0.737693956189428, 0.954319732813675, 0.846006844501551,
                                   1, "d1", "dem60", 0, "y4", 0.0552626931752225, 15.3088240165766,
                                   0.778492133069873, 0.965853919956185, 0.872173026513029, 1,
                                   "a1", "dem65", 0, "y5", 0.0477972524914228, 18.2473464697483,
                                   0.67087444833091, 0.924782371821395, 0.797828410076152, 1, "b1",
                                   "dem65", 0, "y6", 0.0647736196923205, 12.3171811899026, 0.736192759464658,
                                   0.949483386056646, 0.842838072760652, 1, "c1", "dem65", 0, "y7",
                                   0.0544118739615619, 15.4899659099419, 0.638932514709072, 0.895780249949813,
                                   0.767356382329443, 1, "d1", "dem65", 0, "y8", 0.0655235854502235,
                                   11.7111476280916, 0.892603067451178, 0.987227713249421, 0.9399153903503,
                                   1, "", "ind60", 0, "x1", 0.0241393838214963, 38.9370083884784,
                                   0.966178590398428, 1.0271184895563, 0.996648539977362, 1, "",
                                   "ind60", 0, "x2", 0.0155461783069882, 64.1089096173147, 0.767581946985848,
                                   0.946772733488142, 0.857177340236995, 1, "", "ind60", 0, "x3",
                                   0.0457127753151915, 18.7513738627052, 0.706136914870295, 0.947767384462952,
                                   0.826952149666623, 2, "a2", "dem60", 0, "y1", 0.0616415585945986,
                                   13.4154970854206, 0.566525634209488, 0.874563219521445, 0.720544426865466,
                                   2, "b2", "dem60", 0, "y2", 0.0785824606323682, 9.16927799240577,
                                   0.590939431339302, 0.883775787875685, 0.737357609607493, 2,
                                   "c2", "dem60", 0, "y3", 0.0747045248908244, 9.87032058212125,
                                   0.717917492456381, 0.949294324383668, 0.833605908420025, 2,
                                   "d2", "dem60", 0, "y4", 0.0590257866349478, 14.1227411940405,
                                   0.636987854265182, 0.910032545908851, 0.773510200087017, 2,
                                   "a2", "dem65", 0, "y5", 0.0696555380092214, 11.1047911220586,
                                   0.63997340237183, 0.91899976227282, 0.779486582322325, 2, "b2",
                                   "dem65", 0, "y6", 0.0711815018290934, 10.9506903098767, 0.655212215313434,
                                   0.91719625218529, 0.786204233749362, 2, "c2", "dem65", 0, "y7",
                                   0.0668338905557329, 11.7635562917551, 0.821079139252476, 0.992174423599887,
                                   0.906626781426181, 2, "d2", "dem65", 0, "y8", 0.0436475582451996,
                                   20.7715349466517, 0.801506609723532, 0.974376101362245, 0.887941355542888,
                                   2, "", "ind60", 0, "x1", 0.0441001704628977, 20.1346467875885,
                                   0.883183839688211, 1.01439639349145, 0.948790116589829, 2, "",
                                   "ind60", 0, "x2", 0.0334732053339304, 28.3447643308924, 0.769812526009361,
                                   0.96151378589211, 0.865663155950736, 2, "", "ind60", 0, "x3",
                                   0.0489042812507942, 17.701173267661), "Loadings parameter table")
  expect_equal_tables(parlvar, list(1, 1, "ind60", 1, 1, "", "ind60", "", 0, "", 0.476503637802626,
                                    1.00720635040754, "dem60", 0.741854994105085, 1, "", "dem60",
                                    4.26381279172716e-08, 0.135385832798723, 5.479561478253, -0.0597329828232586,
                                    0.181967101782467, "dem65", 0.0611170594796042, 1, "", "dem65",
                                    0.321585209881609, 0.0616593178528343, 0.991205572943179, 1,
                                    1, "ind60", 1, 2, "", "ind60", "", 0, "", 0.71389271029197,
                                    1.10500277007187, "dem60", 0.90944774018192, 2, "", "dem60",
                                    0, 0.0997748078191557, 9.11500367738434, -0.102083243916055,
                                    0.146310232721, "dem65", 0.0221134944024726, 2, "", "dem65",
                                    0.727107498848015, 0.0633668471962628, 0.348975771730943), "Latent variance parameter table")
  expect_equal_tables(parmu, list(5.86051216885707, 9.39574922597642, 7.62813069741675, 1, "", "x1",
                                  0, 0.901862759980502, 8.45819456785383, 2.62905298754042, 4.34339813293689,
                                  3.48622556023865, 1, "", "x2", 1.55431223447522e-15, 0.437340981497364,
                                  7.97141294260269, 2.10017844171604, 3.53720633869964, 2.81869239020784,
                                  1, "", "x3", 1.48769885299771e-14, 0.366595485508584, 7.68883551933931,
                                  1.59714904376767, 2.75140023469271, 2.17427463923019, 1, "",
                                  "y1", 1.53654866608122e-13, 0.294457245140632, 7.38400795059997,
                                  0.702486389165998, 1.48051258738365, 1.09149948827483, 1, "",
                                  "y2", 3.81302198704248e-08, 0.198479718085288, 5.49929987206955,
                                  1.54022734744163, 2.62630651375255, 2.08326693059709, 1, "",
                                  "y3", 5.52891066263328e-14, 0.277066102968672, 7.51902491237857,
                                  1.30626922533513, 2.31329207038116, 1.80978064785815, 1, "",
                                  "y4", 1.85806925401266e-12, 0.256898303486519, 7.04473569228189,
                                  1.450132614875, 2.53209818081696, 1.99111539784598, 1, "", "y5",
                                  5.44231326671252e-13, 0.276016695836342, 7.21374984876484, 0.470319485687349,
                                  1.21287408432268, 0.841596785005017, 1, "", "y6", 8.88083719763344e-06,
                                  0.189430674362517, 4.44276930247548, 1.51678500410402, 2.64170207381989,
                                  2.07924353896195, 1, "", "y7", 4.31210622764411e-13, 0.286973913446644,
                                  7.24540957047142, 0.896223709645456, 1.72190724921633, 1.30906547943089,
                                  1, "", "y8", 5.13962650217081e-10, 0.21063742652512, 6.21478101506704,
                                  0, 0, 0, 1, "", "ind60", "", 0, "", 0, 0, 0, 1, "", "dem60",
                                  "", 0, "", 0, 0, 0, 1, "", "dem65", "", 0, "", 5.73878418637275,
                                  9.14485948124631, 7.44182183380953, 2, "", "x1", 0, 0.868912725371548,
                                  8.56452163320246, 2.34618162223923, 3.88457672221115, 3.11537917222519,
                                  2, "", "x2", 1.99840144432528e-15, 0.392454941036311, 7.93818307905302,
                                  1.83077322474632, 3.11088429031373, 2.47082875753003, 2, "",
                                  "x3", 3.84137166520304e-14, 0.326564946005326, 7.56611751430824,
                                  1.6133053689969, 2.7637072376248, 2.18850630331085, 2, "", "y1",
                                  8.83737527601625e-14, 0.293475257122612, 7.457208913515, 0.751411274099746,
                                  1.54504323162187, 1.14822725286081, 2, "", "y2", 1.41672948927862e-08,
                                  0.202460852286621, 5.67135443663586, 1.30682401891467, 2.26888083508133,
                                  1.787852426998, 2, "", "y3", 3.22408766351145e-13, 0.245427166967159,
                                  7.28465576607187, 0.64361569236089, 1.4136442738504, 1.02862998310565,
                                  2, "", "y4", 1.63764484417683e-07, 0.196439472246276, 5.23637113938106,
                                  1.42407132529416, 2.4584885185159, 1.94127992190503, 2, "",
                                  "y5", 1.88737914186277e-13, 0.26388678602798, 7.3564877996551,
                                  0.540424668130737, 1.29070379442682, 0.915564231278779, 2, "",
                                  "y6", 1.72285306865305e-06, 0.191401253342967, 4.78348085651353,
                                  1.3476981868713, 2.35223475960216, 1.84996647323673, 2, "",
                                  "y7", 5.23803223018149e-13, 0.256264038690128, 7.21898586587755,
                                  0.776941695602407, 1.60471747832727, 1.19082958696484, 2, "",
                                  "y8", 1.70874363547568e-08, 0.211171171831281, 5.63916739504705,
                                  0, 0, 0, 2, "", "ind60", "", 0, "", 0, 0, 0, 2, "", "dem60",
                                  "", 0, "", 0, 0, 0, 2, "", "dem65", "", 0, ""), "Means parameter table")
  expect_equal_tables(parreg, list(0.24694809519113, 0.769211352720298, 0.508079723955714, 1, "",
                                   "dem60", 0.000137028469371137, "ind60", 0.133232871024344, 3.8134712556249,
                                   0.125064276981679, 0.520137737898231, 0.322601007439955, 1,
                                   "", "dem65", 0.00137020647281405, "ind60", 0.100785898116711,
                                   3.20085461823618, 0.597192495033522, 0.931524666107076, 0.764358580570299,
                                   1, "", "dem65", 0, "dem60", 0.0852903863822813, 8.96183747068932,
                                   -0.0240106190873737, 0.625848669788988, 0.300919025350807, 2,
                                   "", "dem60", 0.0695035052616753, "ind60", 0.165783477146103,
                                   1.81513278965437, -0.0365328019115215, 0.301009323761608, 0.132238260925043,
                                   2, "", "dem65", 0.12461123710699, "ind60", 0.0861092673986916,
                                   1.5357030075842, 0.840981898773835, 1.04104675719131, 0.941014327982574,
                                   2, "", "dem65", 0, "dem60", 0.0510378915111615, 18.4375627621056), "Regressions parameter table")
  expect_equal_tables(parvar, list(0.0276198979086181, 0.205498220056669, "x1", 0.116559058982644,
                                   1, "", "x1", 0.0102102201489525, 0.0453779568275572, 2.56862730566704,
                                   -0.0540439742981111, 0.0674273498200953, "x2", 0.00669168776099212,
                                   1, "", "x2", 0.829031845733531, 0.0309881520977826, 0.215943427019353,
                                   0.111648727712407, 0.418845287056054, "x3", 0.265247007384231,
                                   1, "", "x3", 0.000712721695697693, 0.078367909249041, 3.38463804797084,
                                   0.0458292902034015, 0.386521719119742, "y1", 0.216175504661572,
                                   1, "", "y1", 0.0128729413887141, 0.0869129309527316, 2.48726515481501,
                                   0.314162969060975, 0.746241287251494, "y2", 0.530202128156234,
                                   1, "", "y2", 1.50829945244624e-06, 0.110226086193088, 4.81013294101232,
                                   0.18846390668376, 0.605910076274246, "y3", 0.397186991479003,
                                   1, "", "y3", 0.00019171623773917, 0.106493326633358, 3.72968902404995,
                                   0.10100552194454, 0.467539316168516, "y4", 0.284272419056528,
                                   1, "", "y4", 0.00236439588913839, 0.0935052371153623, 3.04017644173028,
                                   0.0759023072051822, 0.402726116441024, "y5", 0.239314211823103,
                                   1, "", "y5", 0.00410034538131843, 0.0833749527577513, 2.87033700059104,
                                   0.160894872552334, 0.566044783598383, "y6", 0.363469828075359,
                                   1, "", "y6", 0.000437008878576561, 0.10335646834376, 3.51666261337868,
                                   0.109854529343158, 0.469393436867062, "y7", 0.28962398310511,
                                   1, "", "y7", 0.00159035584167677, 0.0917207944533424, 3.15766980466398,
                                   0.214070428614506, 0.608257936382035, "y8", 0.411164182498271,
                                   1, "", "y8", 4.33704878983754e-05, 0.100559885507292, 4.08874950905204,
                                   0.0580621809405896, 0.365058117292726, "x1", 0.211560149116658,
                                   2, "", "x1", 0.00690606029975549, 0.0783167289740223, 2.70134046567282,
                                   -0.0246958611150511, 0.22429049043797, "x2", 0.0997973146614593,
                                   2, "", "x2", 0.116144659643325, 0.063518093576462, 1.57116356997278,
                                   0.0846785872480784, 0.416576013610746, "x3", 0.250627300429412,
                                   2, "", "x3", 0.00307565088376438, 0.0846692666244463, 2.96007406726551,
                                   0.116333308360717, 0.515966975962785, "y1", 0.316150142161751,
                                   2, "", "y1", 0.00192832793200437, 0.101949237525365, 3.10105450355225,
                                   0.258860957764969, 0.702770500061265, "y2", 0.480815728913117,
                                   2, "", "y2", 2.17788838257071e-05, 0.113244311068417, 4.24582678261542,
                                   0.240378640251277, 0.672228870856571, "y3", 0.456303755553924,
                                   2, "", "y3", 3.44449625533372e-05, 0.110167899515418, 4.14189394152935,
                                   0.112224101292195, 0.497978277602256, "y4", 0.305101189447225,
                                   2, "", "y4", 0.00193289170168387, 0.0984084859091393, 3.10035447277307,
                                   0.190479120517057, 0.61288482020563, "y5", 0.401681970361343,
                                   2, "", "y5", 0.000193302964926367, 0.107758536131392, 3.72761161001264,
                                   0.174903356591656, 0.609897979367265, "y6", 0.392400667979461,
                                   2, "", "y6", 0.000406088480918276, 0.110970055114989, 3.53609509856372,
                                   0.175909945259077, 0.587855860410078, "y7", 0.381882902834578,
                                   2, "", "y7", 0.000279213224398944, 0.105090174717591, 3.63385924384284,
                                   0.0229083125602475, 0.333147445841359, "y8", 0.178027879200803,
                                   2, "", "y8", 0.0244861250318125, 0.0791440903323322, 2.24941468722744), "(Residual) variances parameter table")

  # covariance tables. Use only constrained model (model 2)
  covcont  <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_covars"]][["collection"]][[2]][["collection"]]
  covimp <- covcont[["modelContainer_covars_default_implied"]][["collection"]][["modelContainer_covars_default_implied_1"]][["data"]]
  covobs <- covcont[["modelContainer_covars_default_observed"]][["collection"]][["modelContainer_covars_default_observed_1"]][["data"]]
  covres <- covcont[["modelContainer_covars_default_residual"]][["collection"]][["modelContainer_covars_default_residual_1"]][["data"]]
  covstd <- covcont[["modelContainer_covars_default_stdres"]][["collection"]][["modelContainer_covars_default_stdres_1"]][["data"]]

  expect_equal_tables(covimp, list(0.49008300563634, "", "", "", "", "", "", "", "", "", "", 0.974061924820936,
                                   2.20622852804642, "", "", "", "", "", "", "", "", "", 0.788491080043323,
                                   1.77466015582184, 1.95570584174645, "", "", "", "", "", "",
                                   "", "", 0.835178540092752, 1.87973981648419, 1.5216261310825,
                                   7.64797977172544, "", "", "", "", "", "", "", 0.955666527250095,
                                   2.15092263069125, 1.74114526494313, 6.6837892939784, 14.5127221504755,
                                   "", "", "", "", "", "", 0.788253740427639, 1.77412597456093,
                                   1.43613303237535, 5.51292920802481, 6.30825824454682, 9.62227326013948,
                                   "", "", "", "", "", 0.904244744111686, 2.03518740934666, 1.647459034785,
                                   6.32415300473142, 9.23882105681506, 5.96882824654787, 9.02873362112345,
                                   "", "", "", "", 1.14334478995368, 2.57333087773904, 2.08307951619225,
                                   5.82366205597868, 6.32427984118539, 5.21639829184987, 5.98398776520799,
                                   7.98119516009606, "", "", "", 1.18710886159188, 2.6718308559361,
                                   2.16281403020389, 5.73848644656917, 7.58931007411123, 5.41606756969487,
                                   6.21303824196686, 6.20454284533332, 10.2893215377554, "", "",
                                   1.25970543427747, 2.83522426425121, 2.29507897323411, 6.0894184140595,
                                   6.96791532513603, 6.91162808862569, 6.59299099686961, 6.58397607191045,
                                   6.83599243915776, 9.9403352106315, "", 1.15531617741013, 2.60027492931625,
                                   2.10489039267504, 5.58480055205702, 6.39049819021453, 5.27101657115423,
                                   5.85298682041024, 6.03837521104465, 7.68811256412372, 6.65291356937697,
                                   10.6193105678442), "Model-implied covariance table")

  expect_equal_tables(covobs, list(0.490082575997078, "", "", "", "", "", "", "", "", "", "", 0.973932449184952,
                                   2.20622591129467, "", "", "", "", "", "", "", "", "", 0.78518275394412,
                                   1.77565205254938, 1.95570361423433, "", "", "", "", "", "",
                                   "", "", 0.842173686632578, 1.60646357669832, 1.14904644265887,
                                   7.62580350620891, "", "", "", "", "", "", "", 0.966640855417166,
                                   2.56661076528232, 2.30600417597728, 6.02486581738495, 14.676007521986,
                                   "", "", "", "", "", "", 0.569651258731629, 1.29778304025924,
                                   0.751981605089701, 6.44636651314828, 5.79397804058276, 9.73209047934931,
                                   "", "", "", "", "", 1.07850808055391, 2.50663181045844, 2.0195628491114,
                                   6.09461043973703, 9.30788611653126, 5.64475186161118, 9.01279131583053,
                                   "", "", "", "", 1.23810412812272, 2.61063748721578, 1.81722127066318,
                                   5.59878435062089, 6.6520705502466, 5.03859665459321, 6.05661431962235,
                                   7.93189524242966, "", "", "", 1.43792308816034, 2.91763544604397,
                                   2.84145873393433, 5.38621551022644, 8.42865402090701, 4.21966332811402,
                                   6.90922843998977, 6.08535469304967, 10.3746040258343, "", "",
                                   1.04665319855464, 2.45836864046895, 1.77472198140307, 6.2463340788897,
                                   7.67698969559927, 6.73419489425259, 7.01801387855084, 6.81611022694302,
                                   6.30443702471928, 9.78003437719124, "", 1.23565159843141, 2.65937421505933,
                                   1.72765599854139, 5.4174694403214, 7.39753077439182, 4.59181056574472,
                                   6.45111697395995, 5.63862367744565, 7.7210072538895, 6.57011319209561,
                                   10.545706988345), "Observed covariance table")

  expect_equal_tables(covres, list(-4.29639262000681e-07, "", "", "", "", "", "", "", "", "", "",
                                   -0.000129475635983867, -2.61675175305953e-06, "", "", "", "",
                                   "", "", "", "", "", -0.00330832609920362, 0.000991896727542851,
                                   -2.22751211431671e-06, "", "", "", "", "", "", "", "", 0.00699514653982602,
                                   -0.273276239785871, -0.372579688423628, -0.0221762655165261,
                                   "", "", "", "", "", "", "", 0.0109743281670703, 0.415688134591076,
                                   0.56485891103415, -0.65892347659345, 0.163285371510497, "",
                                   "", "", "", "", "", -0.21860248169601, -0.476342934301688, -0.684151427285647,
                                   0.933437305123476, -0.514280203964063, 0.109817219209827, "",
                                   "", "", "", "", 0.174263336442222, 0.471444401111776, 0.372103814326393,
                                   -0.229542564994383, 0.0690650597162001, -0.324076384936694,
                                   -0.0159423052929153, "", "", "", "", 0.094759338169033, 0.0373066094767367,
                                   -0.265858245529067, -0.224877705357793, 0.327790709061214, -0.177801637256668,
                                   0.0726265544143621, -0.0492999176663993, "", "", "", 0.250814226568454,
                                   0.245804590107875, 0.678644703730438, -0.352270936342729, 0.839343946795778,
                                   -1.19640424158084, 0.696190198022915, -0.119188152283651, 0.0852824880789491,
                                   "", "", -0.213052235722835, -0.376855623782256, -0.52035699183104,
                                   0.156915664830205, 0.709074370463244, -0.177433194373092, 0.425022881681233,
                                   0.232134155032578, -0.531555414438472, -0.160300833440264, "",
                                   0.0803354210212817, 0.0590992857430783, -0.377234394133652,
                                   -0.167331111735621, 1.00703258417729, -0.679206005409508, 0.598130153549711,
                                   -0.399751533598995, 0.0328946897657785, -0.0828003772813588,
                                   -0.073603579499208), "Residual covariance table")

  expect_equal_tables(covstd, list(-4.29639262000681e-07, "", "", "", "", "", "", "", "", "", "",
                                   -0.656501234914186, -2.61675175305953e-06, "", "", "", "", "",
                                   "", "", "", "", -0.214382032841467, 0.628428509733918, -2.22751211431671e-06,
                                   "", "", "", "", "", "", "", "", 0.0584211384301864, -1.38655438787053,
                                   -1.10778259399768, -0.72954385573341, "", "", "", "", "", "",
                                   "", 0.0392830302958012, 0.763733839244148, 0.937240095012147,
                                   -1.91240339032812, 0.707671862819275, "", "", "", "", "", "",
                                   -1.11128819406366, -1.29553507117159, -1.41725285795056, 2.24213938807433,
                                   -0.692920509517774, 1.01252981836045, "", "", "", "", "", 1.12296637858533,
                                   1.76092005122248, 1.03897439873148, -1.89946318160954, 0.50788063705011,
                                   -0.955310631704191, -0.529445188320897, "", "", "", "", 0.84637576987438,
                                   0.212613391499169, -0.886659291447441, -1.58033603835125, 0.535855697540597,
                                   -0.363877931669033, 0.264359046283236, -1.65206694694975, "",
                                   "", "", 1.59420837732785, 0.80200027361724, 1.85877762080463,
                                   -0.783643049078432, 1.42727340471651, -1.69574616927037, 1.49006161731203,
                                   -0.36146308826175, 0.587112022296334, "", "", -1.49267117349096,
                                   -1.77713976403023, -1.43308803879204, 0.481115877626993, 1.09173478328435,
                                   -0.696178527209725, 1.34350159587593, 0.811438955930301, -1.38681969134065,
                                   -1.45788452177961, "", 0.452061784650381, 0.17774159935726,
                                   -0.855930584721834, -0.360497525449585, 1.06637178177209, -0.920728775886069,
                                   1.62394404220375, -1.18787243368823, 0.201587985936387, -0.192381097445062,
                                   -1.73906392430061), "Standardized residual covariance table")
})


test_that("Bootstrapping works", {
  options <- jaspTools::analysisOptions("SEM")
  options$models <- list(list(name = "Model1", syntax = list(model = "x1 ~ x2 + x3 + y1", columns = c("x1", "x2", "x3", "y1"))))
  options$emulation         <- "lavaan"
  options$estimator         <- "default"
  options$group             <- ""
  options$samplingWeights   <- ""
  options$informationMatrix <- "expected"
  options$naAction          <- "fiml"
  options$modelTest         <- "standard"
  options$errorCalculationMethod    <- "bootstrap"
  options$bootstrapCiType   <- "percentile"
  options$bootstrapSamples  <- 100
  options$ciLevel           <- 0.95

  set.seed(1)
  results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)

  # Model fit table results match
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(48.1563554263441, 59.7437959940257, 0, 0, "Model1", 75, 1, 0,
                                      0, ""),
                                 label = "Model fit table results match")

  # Residual covariances table results match
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_cov"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(1.782009228184, 1.782009228184, 1.782009228184, "", "x2 - x3",
                                      "", 0, "", 1.2564136096, 1.2564136096, 1.2564136096, "", "x2 - y1",
                                      "", 0, "", 0.899301179999998, 0.899301179999998, 0.899301179999998,
                                      "", "x3 - y1", "", 0, ""),
                                 label = "Residual covariances table results match")

  # Regression coefficients table results match
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_reg"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.249609316197927, 0.447867152439518, 0.355178154406208, "", "x1",
                                      3.13082892944294e-14, "x2", 0.0467810932812294, 7.59234403247094,
                                      -0.0367153099343007, 0.19997796482335, 0.0779182667327594, "",
                                      "x1", 0.112759784761359, "x3", 0.0491315895805092, 1.58590974560428,
                                      0.00301905711375345, 0.056769954444189, 0.0306885894512192,
                                      "", "x1", 0.0358943944804584, "y1", 0.014626696431825, 2.09812171834281
                                 ),
                                 label = "Regression coefficients table results match")

  # Residual variances table results match
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_var"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(0.0579281075433614, 0.121472727074924, "x1", 0.0973808551508767,
                                      "", "x1", 9.14129882900738e-10, 0.0159022270557018, 6.12372435695796,
                                      2.25167664969695, 2.25167664969695, "x2", 2.25167664969695,
                                      "", "x2", "", 0, "", 1.94967853807201, 1.94967853807201, "x3",
                                      1.94967853807201, "", "x3", "", 0, "", 6.78685155555555, 6.78685155555555,
                                      "y1", 6.78685155555555, "", "y1", "", 0, ""),
                                 label = "Residual variances table results match")

})


test_that("t-size RMSEA and CFI match values of original article (Katerina M. Marcoulides & Ke-Hai Yuan (2017))", {
  options <- jaspTools::analysisOptions("SEM")
  options$sampleSize            <- 600
  options$samplingWeights       <- ""
  options$additionalFitMeasures <- TRUE
  options$informationMatrix     <- "expected"
  options$estimator             <- "default"
  options$modelTest             <- "standard"
  options$naAction              <- "ml"
  options$emulation             <- "mplus"
  options$group                 <- ""
  options$dataType              <- "varianceCovariance"
  options$errorCalculationMethod <- "standard"
  options$ciLevel               <- 0.95
  options$models <- list(list(name = "Model1", syntax = list(model = "factor1 =~ V1 + V2 + V3 + V4 + V5 + V6 + V7\n factor2 =~ V8 + V9 + V10 + V11 + V12",
                                                                  columns = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12"))))
  set.seed(1)
  dataset <- structure(list(V1 = c(1.321, 0.443, 0.283, 0.379, 0.462, 0.316, 0.392, 0.404, 0.398, 0.313, 0.374, 0.381),
                            V2 = c(0.443, 1.41, 0.507, 0.526, 0.466, 0.392, 0.404, 0.342, 0.493, 0.423, 0.448, 0.486),
                            V3 = c(0.283, 0.507, 1.485, 0.542, 0.411, 0.37, 0.352, 0.389, 0.437, 0.372, 0.359, 0.387),
                            V4 = c(0.379, 0.526, 0.542, 1.547, 0.527, 0.418, 0.481, 0.449, 0.45, 0.379, 0.368, 0.359),
                            V5 = c(0.462, 0.466, 0.411, 0.527, 1.524, 0.496, 0.478, 0.426, 0.447, 0.398, 0.348, 0.37),
                            V6 = c(0.316, 0.392, 0.37, 0.418, 0.496, 1.441, 0.387, 0.391, 0.48, 0.3, 0.404, 0.438),
                            V7 = c(0.392, 0.404, 0.352, 0.481, 0.478, 0.387, 1.422, 0.405, 0.412, 0.351, 0.335, 0.371),
                            V8 = c(0.404, 0.342, 0.389, 0.449, 0.426, 0.391, 0.405, 1.566, 0.657, 0.538, 0.591, 0.556),
                            V9 = c(0.398,0.493, 0.437, 0.45, 0.447, 0.48, 0.412, 0.657, 1.646, 0.599, 0.608, 0.69),
                            V10 = c(0.313, 0.423, 0.372, 0.379, 0.398, 0.3, 0.351, 0.538, 0.599, 1.675, 0.659, 0.529),
                            V11 = c(0.374, 0.448, 0.359, 0.368, 0.348, 0.404, 0.335, 0.591, 0.608, 0.659, 1.63, 0.64),
                            V12 = c(0.381, 0.486, 0.387, 0.359, 0.37, 0.438, 0.371, 0.556, 0.69, 0.529, 0.64, 1.673)),
                       class = "data.frame", row.names = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12"))
  results <- jaspTools::runAnalysis("SEM", dataset, options)

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_addfit"]][["collection"]][["modelContainer_addfit_incrits"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list("Log-likelihood", -10988.8301074082, "Number of free parameters",
                                      25, "Akaike (AIC)", 22027.6602148165, "Bayesian (BIC)", 22137.5834561969,
                                      "Sample-size adjusted Bayesian (SSABIC)", 22058.2153051905
                                 ))

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_addfit"]][["collection"]][["modelContainer_addfit_indices"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list("Comparative Fit Index (CFI)", 0.996320596799013, "T-size CFI",
                                      0.974924004613771, "Tucker-Lewis Index (TLI)", 0.995418101674243,
                                      "Bentler-Bonett Non-normed Fit Index (NNFI)", 0.995418101674243,
                                      "Bentler-Bonett Normed Fit Index (NFI)", 0.961983689254564,
                                      "Parsimony Normed Fit Index (PNFI)", 0.772502053492302, "Bollen's Relative Fit Index (RFI)",
                                      0.952658933788703, "Bollen's Incremental Fit Index (IFI)", 0.99635284058013,
                                      "Relative Noncentrality Index (RNI)", 0.996320596799013))

  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_addfit"]][["collection"]][["modelContainer_addfit_others"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list("Root mean square error of approximation (RMSEA)", 0.0130437119174326,
                                      "RMSEA 90% CI lower bound", 0, "RMSEA 90% CI upper bound", 0.0297980428059356,
                                      "RMSEA p-value", 0.999994986450328, "T-size RMSEA", 0.0298232086120238,
                                      "Standardized root mean square residual (SRMR)", 0.0253510370222869,
                                      "Hoelter's critical N (<unicode> = .05)", 730.254899917344,
                                      "Hoelter's critical N (<unicode> = .01)", 821.1621871771, "Goodness of fit index (GFI)",
                                      0.984016681546699, "McDonald fit index (MFI)", 0.99550148064049,
                                      "Expected cross validation index (ECVI)", 0.18068400295767
                                 ))
})


test_that("Variance-covariance input works", {
  options <- jaspTools::analysisOptions("SEM")
  options$dataType          <- "varianceCovariance"
  options$sampleSize        <- 75
  options$emulation         <- "lavaan"
  options$estimator         <- "default"
  options$group             <- ""
  options$samplingWeights   <- ""
  options$informationMatrix <- "expected"
  options$naAction          <- "fiml"
  options$modelTest         <- "standard"
  options$errorCalculationMethod <- "standard"
  options$ciLevel           <- 0.95
  options$models <- list(
    list(name = "Model1", syntax = list(model = "F =~ x1 + x3 + y1", columns = c("x1", "x2", "x3"))),
    list(name = "Model2", syntax = list(model = "F =~ y1 + y2 + y3", columns = c("y1", "y2", "y3")))
    )

  data <- read.csv("poldem_grouped.csv")
  data <- cov(data)
  data <- as.data.frame(data)

  set.seed(1)
  results <- jaspTools::runAnalysis("SEM", data, options)
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_fittab"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(707.570148255052, 721.47507693627, 0, 0, "Model1", 75, 1, "",
                                      "", "", 1095.63355300898, 1109.53848169019, 0, 0, "Model2",
                                      75, 1, "", 0, 0))
})


test_that("Fixing mean manifest intercepts works", {
  options <- jaspTools::analysisOptions("SEM")
  options$models <- list(list(name = "Model1", syntax = list(model = "factor =~ x2 + x3 + y1 + x1", columns = c("x1", "x2", "x3", "y1"))))
  options$emulation         <- "lavaan"
  options$estimator         <- "default"
  options$meanStructure     <- TRUE
  options$manifestMeanFixedToZero <- TRUE
  options$group             <- "group"
  options$samplingWeights   <- ""
  options$informationMatrix <- "expected"
  options$naAction          <- "fiml"
  options$modelTest         <- "standard"
  options$errorCalculationMethod <- "standard"
  options$ciLevel <- .95

  set.seed(1)

  results <- jaspTools::runAnalysis("SEM", "poldem_grouped.csv", options)
  table <- results[["results"]][["modelContainer"]][["collection"]][["modelContainer_params"]][["collection"]][["modelContainer_params_mu"]][["data"]]
  jaspTools::expect_equal_tables(table,
                                 list(-3.0031653252094, -0.238164753555845, -1.62066503938262, 1, "",
                                      "x2", 0.0215840525894235, 0.705370250031003, -2.29760900649183,
                                      -2.90748296601922, -0.257527727837225, -1.58250534692822, 1,
                                      "", "x3", 0.0192367987813871, 0.676021411384215, -2.34091009586205,
                                      -2.02601609127232, 3.81817181538369, 0.896077862055687, 1, "",
                                      "y1", 0.547816766514775, 1.49089165738611, 0.601034862336494,
                                      1.63165251250819, 2.98253253600213, 2.30709252425516, 1, "",
                                      "x1", 2.16224815829946e-11, 0.344618583338652, 6.6946259888371,
                                      5.33697746290641, 8.26080927533766, 6.79889336912203, 1, "",
                                      "factor", 0, 0.745889168243412, 9.11515230222956, -4.07239223241945,
                                      -0.696581025547053, -2.38448662898325, 2, "", "x2", 0.00562595928754916,
                                      0.861192152891677, -2.76882066444372, -3.8707672830057, -0.886230339808109,
                                      -2.37849881140691, 2, "", "x3", 0.00178440810521097, 0.761375455554092,
                                      -3.12394994356096, -0.553574385842091, 6.22823829704087, 2.83733195559939,
                                      2, "", "y1", 0.101006267898262, 1.73008604657459, 1.63999470501311,
                                      1.12212007800144, 2.7291868915801, 1.92565348479077, 2, "",
                                      "x1", 2.63986228365987e-06, 0.409973557232427, 4.69701874869713,
                                      5.05992393096499, 8.54168933431517, 6.80080663264008, 2, "",
                                      "factor", 1.90958360235527e-14, 0.88822178132198, 7.65665374983052
                                 ))
})

